<style>
    .modal-content.guess-mode #guessAgeContainer .gma-slider-wrap,
    .modal-content.guess-mode #guessAgeContainer .gma-actions {
        opacity: 0;
        /* ⚡️ use CSS vars so we can override on repeat views */
        animation: fadeIn var(--gma-duration, 0.6s) ease-out forwards;
        animation-delay: var(--gma-delay, 3s);
    }

    .modal-content.guess-mode.gma-fast #guessAgeContainer {
        /* ⚡️ much snappier on repeat visits */
        --gma-duration: 0.2s;
        --gma-delay: 0.3s;
    }

    /* when guessing, hide all modal-content children except the athlete-profile */
    .modal-content.guess-mode > :not(.athlete-profile) {
        display: none;
    }

    /* during guess mode, hide everything under athlete-profile except pic, name & slider */
    .modal-content.guess-mode .athlete-profile > *:not(#modalProfilePic):not(#guessAgeContainer) {
        display: none;
    }

    /* ✨ card container */
    .gma-card {
        width: min(420px, 90%);
        margin-inline: auto;
        background: var(--card-bg);
        border-radius: 1.25rem;
        padding: 2rem 2.25rem 2.5rem;
        text-align: center;
    }

    /* avatar with subtle hover zoom */
    .gma-avatar {
        margin: 0 0 1.25rem;
        display: inline-block;
        aspect-ratio: 1;
        width: 144px;
        border-radius: 50%;
        overflow: hidden;
        background: var(--card-bg);
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }

        .gma-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform .25s cubic-bezier(.4,0,.2,1);
        }

        .gma-avatar:hover img {
            transform: scale(1.06);
        }

    /* apply the same headline styles to both */
    .gma-heading,
    .chrono-age-heading {
        font-size: 3rem;
        margin: 0 0 2.5rem;
        color: var(--dark-text-color);
        font-weight: 700;
    }

    /* make the guess‐container fill the modal’s width */
    #guessAgeContainer {
        width: 100%;
        box-sizing: border-box; /* include any padding in that 100% */
    }

    /* let the slider wrap fill all of that */
    .gma-slider-wrap {
        position: relative;
        width: 90%;
        max-width: none; /* override any upstream caps */
        margin: 2rem auto; /* 2rem top/bottom, auto left/right to center */
        padding-top: 3rem; /* space for bubble */
        align-self: stretch; /* <-- this forces it to span the full parent width */
    }

    /* slider track */
    #gmaRange {
        width: 100%;
        height: 3rem;
        appearance: none;
        background: linear-gradient( 90deg, var(--primary-color) 0%, var(--primary-color) var(--percent, 50%), #d1d5db var(--percent, 50%), #d1d5db 100% );
        border-radius: 999px;
        outline: none;
    }

        /* WebKit thumb */
        #gmaRange::-webkit-slider-thumb {
            appearance: none;
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: var(--primary-color);
            border: 4px solid #fff;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            cursor: pointer;
            transition: transform .2s ease;
        }

        #gmaRange:active::-webkit-slider-thumb {
            transform: scale(1.15);
        }

        /* Firefox track and thumb */
        #gmaRange::-moz-range-track {
            background: linear-gradient( 90deg, var(--primary-color) 0%, var(--primary-color) var(--percent, 50%), #d1d5db var(--percent, 50%), #d1d5db 100% );
            height: .5rem;
            border-radius: 999px;
            border: none;
        }

        #gmaRange::-moz-range-thumb {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: var(--primary-color);
            border: 4px solid #fff;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            transition: transform .2s ease;
        }

    #gmaBubble {
        position: absolute;
        bottom: calc(50% + 0.5rem);
        left: var(--percent, 50%);
        transform: translateX(-50%);
        background: #fff;
        color: var(--primary-color);
        font-size: 2.8rem;
        font-weight: 600;
        padding: 0.8rem 1.6rem;
        border: 2px solid var(--primary-color);
        border-radius: 2rem;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        pointer-events: none;
        white-space: nowrap;
        z-index: 10;
    }

        #gmaBubble::after {
            content: '';
            position: absolute;
            bottom: -10px;
            width: 20px;
            height: 20px;
            left: 50%;
            transform: translateX(-50%) rotate(45deg);
            background: #fff;
            border-left: 4px solid var(--primary-color);
            border-bottom: 4px solid var(--primary-color);
        }

    @keyframes bubblePulse {
        0%,100% {
            transform: translateX(-50%) scale(1);
        }

        50% {
            transform: translateX(-50%) scale(1.05);
        }
    }

    /* action buttons */
    .gma-actions {
        display: flex;
        justify-content: center;
        gap: 1rem;
        transition: opacity 0.6s ease-out;
    }

    .gma-btn {
        padding: 1.2rem 2.4rem;
        font-size: 1.2rem;
        min-width: 140px;
        min-height: 48px;
        border: none;
        border-radius: 999px;
        cursor: pointer;
        font-weight: 600;
        transition: background .25s cubic-bezier(.4,0,.2,1), color .25s cubic-bezier(.4,0,.2,1);
    }

    .gma-btn--primary {
        background: var(--primary-color);
        color: #fff;
    }

        .gma-btn--primary:hover {
            background: var(--primary-color);
            filter: brightness(1.1);
        }

    .gma-btn--ghost {
        background: transparent;
        color: var(--primary-color);
        border: 2px solid var(--primary-color);
        padding: 0.8rem 1.6rem;
        font-size: 1rem;
        min-width: 100px;
        min-height: 36px;
    }

        .gma-btn--ghost:hover {
            background: var(--primary-color);
            color: #fff;
            border-color: var(--primary-color);
        }

    /* small screens - keep it tight */
    @media (max-width: 420px) {
        .gma-card {
            padding: 1.5rem 1.25rem;
        }

        .gma-avatar {
            width: 116px;
        }
    }

    /* fade-out and remove when done */
    .gma-card.gma-done {
        opacity: 0;
        height: 0;
        padding: 0; /* collapse the padding too */
        overflow: hidden;
        transition: opacity .3s ease, height .3s ease, padding .3s ease; /* animate padding away */
        pointer-events: none;
    }

    .modal-content.gma-fast .gma-card.gma-done {
        /* collapse WAY faster on repeat visits */
        transition: opacity .1s ease, height .1s ease, padding .1s ease !important;
    }

    /* full-screen slide-up trollface overlay */
    .gma-trollface-container {
        position: absolute;
        left: 0;
        right: 0;
        height: 100%;
        bottom: -100%;
        background: transparent;
        overflow: hidden;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        animation: gmaTrollSlideUpOverlay 2s ease-out forwards;
    }

    @keyframes gmaTrollSlideUpOverlay {
        from {
            bottom: -100%;
        }

        to {
            bottom: 0;
        }
    }

    .gma-trollface-container img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    /* 🚀 fast-mode “boom” for the heading */
    @keyframes gmaBoom {
        0% {
            transform: scale(0.5);
            opacity: 0;
        }

        70% {
            transform: scale(1.2);
        }

        100% {
            transform: scale(1);
            opacity: 1;
        }
    }

    /* disable the slow typewriter + pop in instantly */
    .modal-content.guess-mode.gma-fast .gma-heading {
        opacity: 0; /* start hidden */
        animation: gmaBoom 0.3s cubic-bezier(.4,0,.2,1) forwards !important;
    }

    /* slam in slider & buttons super-fast */
    .modal-content.guess-mode.gma-fast #guessAgeContainer .gma-slider-wrap,
    .modal-content.guess-mode.gma-fast #guessAgeContainer .gma-actions {
        opacity: 0; /* start hidden */
        animation: fadeIn 0.2s ease-out forwards !important;
        animation-delay: 0.25s !important;
    }

    .gma-heading,
    .chrono-age-heading {
        overflow: hidden;
        white-space: nowrap;
        display: inline-block;
        /* steps() can take a var() number for the step count */
        animation: typing 2s steps(var(--ch), end) forwards;
    }

    @keyframes typing {
        from {
            width: 0;
        }
        /* multiply the integer in --ch by 1ch */
        to {
            width: calc(var(--ch) * 1ch);
        }
    }

    .chrono-age-heading--boom {
        animation: gmaBoom 0.3s cubic-bezier(.4,0,.2,1) forwards;
    }

    @keyframes fadeOutButtons {
        from {
            opacity: 1;
        }

        to {
            opacity: 0;
        }
    }

    .gma-actions.gma-actions-hide {
        opacity: 0 !important;
        animation: none !important;
    }
</style>

<div id="guessAgeContainer" class="gma-card">
    <h3 class="gma-heading">Guess my age!</h3>
    <h3 class="chrono-age-heading" style="display: none;">My real age is:</h3>

    <div class="gma-slider-wrap">
        <input type="range"
               min="1"
               max="130"
               value="33"
               id="gmaRange"
               aria-label="Guess athlete’s age — 1 to 130 years" />

        <output for="gmaRange" id="gmaBubble">33</output>
    </div>

    <div class="gma-actions">
        <button id="gmaSkipAll" class="gma-btn gma-btn--ghost" style="display: none;" title="The Guess My Age game will no longer appear for any athlete">Skip All</button>
        <button class="gma-btn gma-btn--ghost">Skip</button>
        <button class="gma-btn gma-btn--primary">Submit</button>
    </div>
</div>

<script>
    /* === Guess-My-Age bindings for the new widget === */
    const gmaRange = document.getElementById('gmaRange');
    const gmaBubble = document.getElementById('gmaBubble');
    const gmaCard = document.querySelector('.gma-card');

    const heading = gmaCard.querySelector('.gma-heading');
    const chronoHeading = gmaCard.querySelector('.chrono-age-heading');

    heading.style.setProperty('--ch', heading.textContent.length);
    chronoHeading.style.setProperty('--ch', chronoHeading.textContent.length);
    heading.classList.add('typing');

    const modalContent = document.querySelector('.modal-content');
    const gmaActions = gmaCard.querySelector('.gma-actions');

    // whenever the modal’s class list changes, if we just opened “guess-mode”,
    // remove any lingering hide classes so buttons reappear
    const resetObserver = new MutationObserver(mutations => {
        mutations.forEach(mutation => {
            if (
                mutation.attributeName === 'class' &&
                modalContent.classList.contains('guess-mode')
            ) {
                // hide the chrono prompt again
                chronoHeading.style.display = 'none';
                chronoHeading.classList.remove('typing', 'chrono-age-heading--boom');
                // restore the original prompt
                heading.style.display = '';
                gmaActions.classList.remove('gma-actions-hide');
                gmaCard.classList.remove('gma-done');
            }
        });
    });

    resetObserver.observe(modalContent, { attributes: true });

    function syncRange() {
        const val = +gmaRange.value;
        const pct = (val / gmaRange.max) * 100;
        gmaRange.style.setProperty('--percent', `${pct}%`);
        gmaBubble.textContent = val;
        const clampedPct = Math.min(Math.max(pct, 5), 95);
        gmaBubble.style.left = `${clampedPct}%`;
    }
    gmaRange.addEventListener('input', syncRange);
    syncRange();   // initialise bubble

    const gmaSubmitBtn = gmaCard.querySelector('.gma-btn--primary');
    gmaSubmitBtn.addEventListener('click', function (e) {
        // 1) hide the slider & buttons
        gmaActions.classList.add('gma-actions-hide');

        // 2) swap headings
        heading.style.display = 'none';
        chronoHeading.style.display = 'inline-block';

        // 3) clear old animations, force reflow
        chronoHeading.classList.remove('typing', 'chrono-age-heading--boom');
        void chronoHeading.offsetWidth;

        // 4) run typewriter or boom
        if (!sessionStorage.getItem('gmaSubmittedOnce')) {
            chronoHeading.classList.add('typing');
            sessionStorage.setItem('gmaSubmittedOnce', 'true');
        } else {
            chronoHeading.classList.add('chrono-age-heading--boom');
        }

        // 5) **capture the button** and collapse after 3s
        const btn = e.currentTarget;
        setTimeout(() => {
            hideCard({ currentTarget: btn });
        }, 3000);
    });

    // bind hideCard to _all_ ghost buttons (Skip & Skip All)
    gmaCard.querySelectorAll('.gma-btn--ghost')
        .forEach(btn => btn.addEventListener('click', hideCard));
    const gmaSkipAll = document.getElementById('gmaSkipAll');
    if (gmaSkipAll) {
        gmaSkipAll.addEventListener('click', hideCard);
    }

    function hideCard(e) {
        // if they clicked “Skip All”, set global flag
        const isSkipAll = e.currentTarget.id === 'gmaSkipAll';
        if (isSkipAll) {
            localStorage.setItem('gmaSkipAll', 'true');
        }

        const modalContent = document.querySelector('.modal-content');
        const athleteSlug = modalContent.dataset.athleteSlug;
        const guessValue = gmaRange.value;

        let allGuesses = JSON.parse(localStorage.getItem('gmaAllGuesses') || '{}');
        const isSkip = e.currentTarget.classList.contains('gma-btn--ghost');

        if (!isSkip) {
            // if they chose the absolute min or max, we’ll troll them instead of collapsing
            const minVal = gmaRange.min;
            const maxVal = gmaRange.max;
            if (guessValue === minVal || guessValue === maxVal) {
                gmaTriggerTrollAnimation();
                return;
            }

            fetch(
                `/api/Guess/athlete-age?athleteName=${encodeURIComponent(athleteSlug)}&ageGuess=${guessValue}`,
                { method: 'POST' }
            )
                .then(response => {
                    if (!response.ok) {
                        console.error('Guess submission failed:', response.statusText);
                        return null;
                    }
                    return response.json();
                })
                .then(data => {
                    if (data) {
                        // immediately update the UI
                        updateCrowdContainer(data.crowdAge, data.crowdCount);
                    }
                })
                .catch(error => console.error('Error submitting guess:', error));
        }

        allGuesses[athleteSlug] = { value: isSkip ? null : guessValue, skipped: isSkip };
        localStorage.setItem('gmaAllGuesses', JSON.stringify(allGuesses));

        gmaCard.classList.add('gma-done');
        document.querySelector('.modal-content').classList.remove('guess-mode');
    }

    function gmaTriggerTrollAnimation() {
        const modalContent = document.querySelector('.modal-content');

        // make sure our card is the positioning context…
        modalContent.style.position = 'relative';
        // …and once we start trolling, show everything (so our iframe isn’t stuck hidden)
        modalContent.classList.remove('guess-mode');

        // grab the guess card itself so we can append into it
        const guessContainer = document.getElementById('guessAgeContainer');

        // create and show trollface
        const trollDiv = document.createElement('div');
        trollDiv.id = 'gmaTrollfaceContainer';
        trollDiv.className = 'gma-trollface-container';
        const trollImg = document.createElement('img');
        trollImg.src = '/assets/content-images/trollface.png';
        trollImg.alt = 'Trollface';
        trollDiv.appendChild(trollImg);
        modalContent.appendChild(trollDiv);

        // halfway through the slide-up, start the rickroll
        setTimeout(() => {
            window.location.href = 'https://www.youtube.com/watch?v=dQw4w9WgXcQ';
            return;
        }, 2000); // 2s == halfway through the 4s slide-up
    }
</script>