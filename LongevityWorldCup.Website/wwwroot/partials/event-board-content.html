<style>
    :root{
        --row-fade-duration:.35s;
        --row-stagger-step:40ms;
        --row-stagger-group-size:8;
        --row-delay: 0ms;
    }
    @keyframes fadeInBoard{
        from{opacity:0; transform:translateY(10px)}
        to{opacity:1; transform:translateY(0)}
    }
    .fade-in-board{ animation: fadeInBoard .6s ease-in-out both; }
    .row-appear{
        opacity:0;
        transform:translateY(8px);
    }
    .row-appear.is-visible{
        opacity:1;
        transform:translateY(0);
        transition:
                opacity var(--row-fade-duration) ease,
                transform var(--row-fade-duration) ease;
        transition-delay: var(--row-delay, 0ms);
    }
    @media (prefers-reduced-motion: reduce){
        .fade-in-board{ animation:none !important }
        .row-appear,
        .row-appear.is-visible{ opacity:1; transform:none; transition:none !important }
    }
    .events-board {
        display: flex;
        align-items: stretch;
        background-color: var(--card-bg);
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        flex-grow: 1;
        margin: 0 auto;
    }
    .events-board table {
        flex-grow: 1;
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        align-self: flex-start;
        padding-bottom:5px;
    }
    .events-board thead th {
        background: rgba(0, 188, 212, 0.12);
        color: var(--primary-color);
        text-transform: uppercase;
        font-weight: 800;
        font-size: 0.95rem;
        letter-spacing: 1px;
        text-align: left;
        padding: 15px 20px;
    }
    .events-board td.col-avatar { padding-right: 8px; }
    .events-board td.event-message { padding-left: 0px; }
    .header-bar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
    }
    .view-all {
        text-decoration: none;
        color: var(--primary-color);
        opacity: 0.8;
        font-weight: 400;
        font-size: 0.85rem;
    }
    .view-all:hover { opacity: 1; text-decoration: underline; }
    .events-board tbody td {
        vertical-align: middle;
        padding: 0 20px;
        height: 40px;
        line-height: 30px;
    }
    .events-board table tr:nth-child(even) { background-color: rgba(240, 244, 248, 0.5); }
    .events-board table tbody tr {
        height: 30px;
        transition: transform 0.25s ease, box-shadow 0.25s ease, background-color 0.25s ease;
        cursor: default;
    }
    .events-board table tbody tr:hover {
        transform: scale(1.01);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
        background-color: rgba(240, 244, 248, 0.8);
    }
    .col-avatar { width: 36px; }
    .avatar,.avatar-fallback {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        overflow: hidden;
        border: 2px solid var(--secondary-color, #ff4f87);
        box-shadow: 0 1px 3px rgba(0,0,0,0.12);
        background: none;
    }
    .avatar { object-fit: cover; display: block; }
    .avatar-fallback {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: #5a6b7b;
        font-weight: 800;
        font-size: 0.7rem;
        text-transform: uppercase;
        line-height: 24px;
    }
    .avatar-link { display: inline-flex; align-items: center; justify-content: center; cursor: pointer; }
    .athlete-td { display: flex; align-items: center; gap: 0.6rem; text-align: left; }
    .event-message a { color: var(--primary-color); text-decoration: underline; cursor: pointer; }
    .event-message { color: var(--dark-text-color); }
    .col-date { text-align: right; white-space: nowrap; color: #7a8a99; font-weight: 400; font-size: 0.8rem; opacity: 50% }
    .event-message{display:flex;align-items:center;gap:.35rem;flex-wrap:wrap}
    .event-message .athlete-name-text{
        color: var(--primary-color);
        text-decoration: none;
        cursor: default;
    }
    @media (max-width:600px){
        .events-board thead th{font-size:.85rem;padding:10px 12px}
        .view-all{font-size:.75rem}
        .events-board tbody td{padding:6px 12px;height:auto;line-height:1.25}
        .events-board table tbody tr{height:auto}
        .col-avatar{width:28px}
        .avatar,.avatar-fallback{width:22px;height:22px;border-width:2px}
        .event-message{font-size:.95rem}
        .col-date{font-size:.72rem;opacity:.6;padding-left:6px}
    }
    @media (max-width:360px){
        .col-date{display:none}
    }
    .event-message a:hover,
    .event-message a:focus {
        color: var(--secondary-color, #ff4f87);
        text-decoration-color: var(--secondary-color, #ff4f87);
    }
    .avatar,
    .avatar-fallback {
        transition: transform .15s ease, box-shadow .15s ease;
        will-change: transform;
    }
    .avatar-link:hover .avatar,
    .avatar-link:focus .avatar,
    .avatar-link:hover .avatar-fallback,
    .avatar-link:focus .avatar-fallback {
        transform: scale(1.15);
        box-shadow: 0 2px 6px rgba(0,0,0,.16);
    }
</style>

<div id="events-root" class="events-board fade-in-board">
    <table id="eventsTable">
        <thead>
        <tr>
            <th colspan="3">
                <div class="header-bar">
                    <span>Highlights</span>
                    <a class="view-all" id="eventsViewAll" href="/event-board/event-board.html" target="_top">View All</a>
                </div>
            </th>
        </tr>
        </thead>
        <tbody>
        <tr><td colspan="3">Loading…</td></tr>
        </tbody>
    </table>
</div>

<script>
    (function(){
        function applyParentTheme(){
            try{
                if(window.parent&&window.parent!==window){
                    var pdoc=window.parent.document;
                    var pr=window.parent.getComputedStyle(pdoc.documentElement);
                    var vars=['--primary-color','--secondary-color','--card-bg','--dark-text-color','--light-text-color','--body-bg'];
                    vars.forEach(function(v){var val=pr.getPropertyValue(v).trim();if(val)document.documentElement.style.setProperty(v,val)});
                    var bf=window.parent.getComputedStyle(pdoc.body).getPropertyValue('font-family');
                    if(bf)document.body.style.fontFamily=bf;
                    var bg=window.parent.getComputedStyle(pdoc.body).getPropertyValue('background-color');
                    if(bg)document.body.style.backgroundColor=bg;
                }
            }catch(e){}
        }
        applyParentTheme();
        window.addEventListener('message',function(e){
            var d=e.data; if(!d||d.type!=='events-theme-vars')return;
            Object.keys(d).forEach(function(k){ if(k.indexOf('--')===0){ document.documentElement.style.setProperty(k,String(d[k]).trim()) }});
            if(d['font-family'])document.body.style.fontFamily=d['font-family'];
            if(d['background-color'])document.body.style.backgroundColor=d['background-color'];
        });
    })();
</script>

<script>
    function lowerKeyMap(o){const m={};Object.keys(o||{}).forEach(k=>m[k.toLowerCase()]=k);return m;}
    function slugifyLocal(s){return(s||"").toString().normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"").replace(/-+/g,"-");}
    function getAthleteName(a){
        if(!a||typeof a!=="object")return"";
        const map=lowerKeyMap(a);
        const nameKey=map["name"]||map["athletename"]||map["fullname"]||map["displayname"];
        if(nameKey)return String(a[nameKey]).trim();
        const slugKey=map["athleteslug"]||map["slug"]||map["key"]||map["id"];
        return slugKey?String(a[slugKey]).trim():"";
    }
    function getAthleteLinkId(a){
        if(!a||typeof a!=="object")return"";
        const map=lowerKeyMap(a);
        const cand=["athleteid","athleteslug","slug","key","id"];
        for(const c of cand){if(map[c]){const v=String(a[map[c]]).trim();if(v)return v;}}
        return slugifyLocal(getAthleteName(a));
    }
    function normalizeLinkId(id){return String(id).replace(/_/g,"-");}
    function getAthleteUrl(a){
        if(!a||typeof a!=="object")return"";
        const map=lowerKeyMap(a);
        const urlKey=map["url"]||map["profileurl"]||map["pageurl"]||map["href"];
        if(urlKey)return String(a[urlKey]).trim();
        let id=getAthleteLinkId(a);
        if(!id)return"";
        id=normalizeLinkId(id);
        return `/athlete/${encodeURIComponent(id)}`;
    }
    function getAthleteImage(a){
        if(!a||typeof a!=="object")return"";
        const map=lowerKeyMap(a);
        const keys=["profilepic","profilepicurl","profilepicture","profilepictureurl","image","avatar","photo","picture","profileimage","img","imageurl"];
        for(const k of keys){if(map[k]){const v=String(a[map[k]]).trim();if(v)return v;}}
        return"";
    }
    function initialsFromName(n){const parts=String(n||"").trim().split(/\s+/).slice(0,2);return parts.map(p=>p.charAt(0)).join("").toUpperCase()||"?";}
    function startOfLocalDay(d){return new Date(d.getFullYear(),d.getMonth(),d.getDate());}
    function relativeDayLabel(iso){
        const dt=new Date(iso); if(isNaN(dt)) return "";
        const today=startOfLocalDay(new Date());
        const thatDay=startOfLocalDay(dt);
        if(thatDay>today) return 'Today <i class="fa fa-rocket"></i>';

        const years = today.getFullYear() - thatDay.getFullYear()
            - ((today.getMonth()<thatDay.getMonth() || (today.getMonth()===thatDay.getMonth() && today.getDate()<thatDay.getDate())) ? 1 : 0);
        if(years>=1) return years===1 ? '1 year ago <i class="fa fa-rocket"></i>' : `${years} years ago <i class="fa fa-rocket"></i>`;

        const months = (today.getFullYear()*12 + today.getMonth()) - (thatDay.getFullYear()*12 + thatDay.getMonth())
            - (today.getDate()<thatDay.getDate()?1:0);
        if(months>=1) return months===1 ? '1 month ago <i class="fa fa-rocket"></i>' : `${months} months ago <i class="fa fa-rocket"></i>`;

        const diffDays=Math.round((today-thatDay)/86400000);
        if(diffDays<=0) return 'Today <i class="fa fa-rocket"></i>';
        if(diffDays===1) return 'Yesterday <i class="fa fa-rocket"></i>';
        return `${diffDays} days ago <i class="fa fa-rocket"></i>`;
    }
    function formatListDate(iso, { separator = ', ' } = {}) {
        const d = new Date(iso);
        if (isNaN(d)) return '';
        const nowYear = new Date().getFullYear();
        const base = d.toLocaleDateString(undefined, { month: 'short', day: 'numeric' }).replace(/,/g, '');
        return d.getFullYear() === nowYear ? base : `${base}${separator}${d.getFullYear()}`;
    }
    
    function setViewAllVisible(show){const link=document.getElementById("eventsViewAll");link.style.display=show?"":"none";}
    function normalizeIncomingAthleteId(id){
        if(id==null) return '';
        let s=String(id).trim();
        if(!s) return '';
        s = s.split('#')[0].split('?')[0];
        if(s.includes('/')) s = s.split('/').filter(Boolean).pop();
        return normalizeLinkId(slugifyLocal(s));
    }
    let rowObserver = null;
    const BIG_LIST_THRESHOLD = 60;
    function ensureRowObserver(){
        if(rowObserver) return rowObserver;
        const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
        rowObserver = new IntersectionObserver((entries, io)=>{
            entries.forEach(entry=>{
                const el = entry.target;
                if(entry.isIntersecting || entry.intersectionRatio > 0){
                    if(!prefersReduced){
                        const idx = Number(el.dataset.rowIndex || 0);
                        const groupSize = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--row-stagger-group-size')) || 8;
                        const stepMs = parseTimeVar('--row-stagger-step', 40);
                        el.style.setProperty('--row-delay', `${(idx % groupSize) * stepMs}ms`);
                    }
                    el.classList.add('is-visible');
                    io.unobserve(el);
                }
            });
        },{
            root: null,
            rootMargin: '0px 0px -10% 0px',
            threshold: 0.01
        });
        return rowObserver;
    }
    function parseTimeVar(varName, fallbackMs){
        const v = getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
        if(!v) return fallbackMs;
        if(v.endsWith('ms')) return parseFloat(v);
        if(v.endsWith('s'))  return parseFloat(v)*1000;
        const n = parseFloat(v); return isNaN(n)?fallbackMs:n;
    }
    function renderRows(events, linkNames){
        const tbody=document.querySelector("#eventsTable tbody");
        tbody.innerHTML="";
        if(!Array.isArray(events)||events.length===0){
            tbody.innerHTML=`<tr><td colspan="3">No events yet.</td></tr>`;
            return;
        }
        const frag = document.createDocumentFragment();
        const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
        events.forEach((e, idx)=>{
            const map=lowerKeyMap(e||{});
            const athlete=map["athlete"]?e[map["athlete"]]:null;
            const whenIso=map["joinedat"]?e[map["joinedat"]]:null;
            const name=getAthleteName(athlete)||"Unknown athlete";
            const url=getAthleteUrl(athlete);
            const img=getAthleteImage(athlete);
            const rel=whenIso?relativeDayLabel(whenIso):"";
            const dateLabel=whenIso?formatListDate(whenIso):"";
            const clickable = !!linkNames;
            const content = img
                ? `<img class="avatar" src="${img}" alt="${name}" loading="lazy">`
                : `<div class="avatar-fallback" title="${name}">${initialsFromName(name)}</div>`;
            const avatarHtml = (clickable && url)
                ? `<a href="${url}" class="avatar-link" title="${name}" aria-label="${name}">${content}</a>`
                : content;
            const nameHtml = (clickable && url) ? `<a href="${url}">${name}</a>` : `<span class="athlete-name-text">${name}</span>`;
            const msgHtml = `${nameHtml} joined ${rel}`;
            const tr=document.createElement("tr");
            tr.className = 'row-appear';
            tr.dataset.rowIndex = idx;
            tr.innerHTML=
                `<td class="col-avatar"><div class="athlete-td">${avatarHtml}</div></td>
                 <td class="athlete-td event-message">${msgHtml}</td>
                 <td class="col-date">${dateLabel}</td>`;
            frag.appendChild(tr);
        });
        tbody.appendChild(frag);
        if(!prefersReduced && events.length){
            const io = ensureRowObserver();
            tbody.querySelectorAll('.row-appear').forEach(r => io.observe(r));
        }else{
            tbody.querySelectorAll('.row-appear').forEach(r => r.classList.add('is-visible'));
        }
    }
    function parseLimit(val){
        if(val===undefined||val===null||val==="")return null;
        const n=typeof val==="string"?parseInt(val,10):Number(val);
        return Number.isFinite(n)&&n>0?Math.floor(n):null;
    }
    window.loadEventsTable = function (maxRows = null, showViewAll = true, athleteId = null, linkNames = true) {
        setViewAllVisible(!!showViewAll);
        fetch("/api/data/events",{headers:{"accept":"application/json"}})
            .then(async r=>{if(!r.ok)throw new Error("HTTP "+r.status);const t=await r.text();return JSON.parse(t);})
            .then(events=>{
                let list = Array.isArray(events) ? events : [];
                const target = normalizeIncomingAthleteId(athleteId);
                if (target) {
                    list = list.filter(ev => {
                        const map = lowerKeyMap(ev || {});
                        const athlete = map["athlete"] ? ev[map["athlete"]] : null;
                        if (athlete && typeof athlete === 'object') {
                            const id = normalizeLinkId(slugifyLocal(getAthleteLinkId(athlete)));
                            if (id && id === target) return true;
                        }
                        const eventIdKeys = ["athleteid","athleteslug","slug","key","id"];
                        for (const k of eventIdKeys) {
                            if (map[k]) {
                                const v = String(ev[map[k]]).trim();
                                if (v && normalizeLinkId(slugifyLocal(v)) === target) return true;
                            }
                        }
                        return false;
                    });
                }
                const n = parseLimit(maxRows);
                if (n !== null) list = list.slice(0, n);
                renderRows(list, linkNames);
            })
            .catch(()=>{
                const tbody=document.querySelector("#eventsTable tbody");
                tbody.innerHTML=`<tr><td colspan="3">Failed to load events.</td></tr>`;
            });
    };
    document.addEventListener('DOMContentLoaded', () => {
        const root = document.getElementById('events-root');
        if(root) root.classList.add('fade-in-board');
    });
</script>
