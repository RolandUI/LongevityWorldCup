<!DOCTYPE html>
<html lang="en">
<head>
    <title>Longevity World Cup 2025 - Pheno Age</title>
    <!--HEAD-->
    <link rel="preload" href="/css/bioageform.css" as="style">
    <link rel="stylesheet" href="/css/bioageform.css">
    <style>
        /* Hide the join-game button in the header */
        .join-game {
            display: none;
        }

        /* Visually Hidden Class for Accessibility */
        .visually-hidden {
            position: absolute !important;
            height: 1px;
            width: 1px;
            overflow: hidden;
            clip: rect(1px, 1px, 1px, 1px);
            white-space: nowrap;
        }

        /* Error Highlighting */
        .errorNaN {
            border: 2px solid red;
        }

        .privacy-note {
            font-size: 0.9rem;
            color: #666;
            margin-top: 0.5rem;
        }

        /* Initial state: hidden and rotated to the left */
        #continueButton {
            opacity: 0;
            transform-origin: left;
            transform: rotate(-90deg);
            overflow: hidden;
            transition: opacity 0.6s ease, transform 0.6s ease;
            pointer-events: none; /* Prevents the button from capturing mouse events */
        }

            /* Final state: fully visible and upright */
            #continueButton.show {
                opacity: 1;
                transform: rotate(0);
                pointer-events: auto; /* Restores mouse events when visible */
            }

        .input-group {
            display: flex;
            align-items: center;
            margin-top: 0.5rem;
        }

            .input-group input {
                flex: 1;
            }

            .input-group select {
                margin-left: 0.5rem;
                padding: 0.5rem;
                border: 1px solid #ccc;
                border-radius: 4px;
                width: auto;
                min-width: var(--unit-select-min-width, auto); /* Placeholder variable for dynamic width */
            }

        #phenoAgeResult {
            max-width: 580px; /* Set max width to match the form */
            padding: 1.5rem;
            color: var(--dark-text-color); /* Standard dark gray */
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.15); /* Faint dark shadow for emphasis */

            border-radius: 8px;
            font-size: 1.5rem;
            opacity: 0;
            transition: opacity 1s;
        }

        .crp-container {
            margin-bottom: 1rem;
        }

        .label-toggle-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

            .label-toggle-group label {
                font-size: 1rem;
                color: #333;
            }

        .negative-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem; /* This sets a small gap between the toggle and the text */
        }

        .toggle-label {
            position: relative;
            display: inline-block;
            width: 36px;
            height: 20px;
            margin-right: 0rem;
        }

            .toggle-label input {
                opacity: 0;
                width: 0;
                height: 0;
            }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 20px;
        }

            .slider:before {
                position: absolute;
                content: "";
                height: 14px;
                width: 14px;
                left: 3px;
                bottom: 3px;
                background-color: white;
                transition: 0.4s;
                border-radius: 50%;
            }

        .toggle-label input:checked + .slider {
            background-color: #f4a6a6; /* Pale red */
        }

            .toggle-label input:checked + .slider:before {
                transform: translateX(16px);
            }

        .bioageform-toggle-text {
            font-size: 0.9rem;
        }

        /* Mini-card container */
        .biomarker-card {
            border: 1px solid #ccc;
            border-radius: 8px;
            margin-bottom: 1rem;
            overflow: hidden;
            transition: box-shadow 0.2s ease;
        }

            .biomarker-card.active {
                box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            }

        /* Header bar */
        .biomarker-card-header {
            background: #f7f7f7;
            padding: 0.75rem 1rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

            .biomarker-card-header:hover {
                background: #ececec;
            }

        /* Toggle icon */
        .toggle-icon {
            font-weight: bold;
            font-size: 1.2rem;
            line-height: 1;
        }

        /* Hidden content by default */
        .biomarker-card-content {
            max-height: 0;
            overflow: hidden;
            padding: 0 1rem; /* keep horizontal padding */
            transition: max-height 0.3s ease, padding 0.3s ease;
        }

            .biomarker-card-content > .input-group:first-of-type {
                margin-top: 0;
            }

        @media (max-width: 768px) {
            /* Must use important because back button styles applied later. Without important it doesn't overwrite it. */
            .back-button {
                margin-right: auto !important;
                margin-left: 0 !important; /* Resets left margin */
            }
        }
    </style>
</head>
<body>
    <!--HEADER-->
    <main>
        <!--MAIN-PROGRESS-BAR-->
        <h1 id="mainPageTitleH2" data-aos="fade" data-aos-duration="700" data-aos-delay="250">
            The Blood Pact
            <span style="display: inline-flex; gap: 9px; align-items: center;">
                <i class="fas fa-tint"></i>
                <i class="fas fa-dna"></i>
                <i class="fas fa-scroll"></i>
            </span>
        </h1>
        <p id="mainInstructions" data-aos="fade" data-aos-duration="700" data-aos-delay="300" style="text-align:center">Calculate your biological age, known as <a href="https://github.com/nopara73/LongevityWorldCup/blob/master/LongevityWorldCup.Documentation/pheno-age.pdf" target="_blank" rel="noopener">PhenoAge</a>:</p>
        <form id="phenoAgeForm" class="bioageform" data-aos="fade" data-aos-duration="700" data-aos-delay="350">
            <!-- Date of Birth Fields -->
            <fieldset id="dobFieldset">
                <legend>Date of Birth:</legend>
                <label for="dob-year">Year <span style="font-weight: normal;">(required)</span></label>
                <select id="dob-year" name="dob-year" required aria-required="true" onchange="calculateResultIfResultAlreadyCalculated()">
                    <option value="" disabled selected>Select Year</option>
                    <!-- Generate year options dynamically here -->
                </select>

                <label for="dob-month" id="dob-month-label">
                    Month <span style="font-weight: normal;">(optional)</span>
                </label>
                <select id="dob-month" name="dob-month" onchange="calculateResultIfResultAlreadyCalculated()">
                    <option value="1">January</option>
                    <option value="2">February</option>
                    <option value="3">March</option>
                    <option value="4">April</option>
                    <option value="5">May</option>
                    <option value="6">June</option>
                    <option value="7">July</option>
                    <option value="8">August</option>
                    <option value="9">September</option>
                    <option value="10">October</option>
                    <option value="11">November</option>
                    <option value="12" selected>December</option>
                </select>

                <label for="dob-day" id="dob-day-label">
                    Day <span style="font-weight: normal;">(optional)</span>
                </label>
                <select id="dob-day" name="dob-day" onchange="calculateResultIfResultAlreadyCalculated()">
                    <option value="" disabled selected>Select Day</option>
                </select>

                <p class="privacy-note" id="privacyNote">Your privacy matters. Consider leaving your birthday at December 31 at the cost of making you appear younger and giving you a slight disadvantage in the competition.</p>
            </fieldset>

            <!-- Biomarker Fieldset -->
            <fieldset>
                <legend>Biomarkers:</legend>

                <!-- Albumin -->
                <div class="biomarker-card">
                    <div class="biomarker-card-header" aria-expanded="false">
                        Albumin
                        <span class="toggle-icon">+</span>
                    </div>
                    <div class="biomarker-card-content">
                        <div class="input-group">
                            <input type="number" id="albumin" name="albumin" step="any" required aria-required="true" inputmode="decimal" onchange="calculateResultIfResultAlreadyCalculated()">
                            <label for="albuminUnit" class="visually-hidden">Select unit for Albumin</label>
                            <select id="albuminUnit" name="albuminUnit" aria-label="Albumin unit" onchange="calculateResultIfResultAlreadyCalculated()">
                                <option value="1">g/L</option>
                                <option value="0.1">g/dL</option>
                                <option value="0.1">g%</option>
                                <!-- Albumin's molar mass can vary slightly depending on its source and exact composition, usually given as approximately 66,500 g/mol but sometimes noted as 66,430 g/mol or 66,563 g/mol in specific contexts. If we calculate using 66,430 g/mol as the molar mass, then it's: 15.0466µmol/L -->
                                <option value="15.0466">µmol/L</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Creatinine -->
                <div class="biomarker-card">
                    <div class="biomarker-card-header" aria-expanded="false">
                        Creatinine
                        <span class="toggle-icon">+</span>
                    </div>
                    <div class="biomarker-card-content">
                        <div class="input-group">
                            <input type="number" id="creatinine" name="creatinine" step="any" required aria-required="true" inputmode="decimal" onchange="calculateResultIfResultAlreadyCalculated()">
                            <label for="creatinineUnit" class="visually-hidden">Select unit for Creatinine</label>
                            <select id="creatinineUnit" name="creatinineUnit" aria-label="Creatinine unit" onchange="calculateResultIfResultAlreadyCalculated()">
                                <option value="1">µmol/L</option>
                                <option value="0.0113">mg/dL</option>
                                <option value="0.00113">mg/L</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Glucose -->
                <div class="biomarker-card">
                    <div class="biomarker-card-header" aria-expanded="false">
                        Glucose
                        <span class="toggle-icon">+</span>
                    </div>
                    <div class="biomarker-card-content">
                        <div class="input-group">
                            <input type="number" id="glucose" name="glucose" step="any" required aria-required="true" inputmode="decimal" onchange="calculateResultIfResultAlreadyCalculated()">
                            <label for="glucoseUnit" class="visually-hidden">Select unit for Glucose</label>
                            <select id="glucoseUnit" name="glucoseUnit" aria-label="Glucose unit" onchange="calculateResultIfResultAlreadyCalculated()">
                                <option value="1">mmol/L</option>
                                <option value="18.016">mg/dL</option>
                                <option value="0.18016">mg%</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- C-Reactive Protein -->
                <div class="biomarker-card">
                    <div class="biomarker-card-header" aria-expanded="false">
                        C-Reactive Protein
                        <span class="toggle-icon">+</span>
                    </div>
                    <div class="biomarker-card-content">
                        <div class="crp-container">
                            <!-- Label and Negative Toggle in the same line -->
                            <div class="label-toggle-group">
                                <span title="Check this box if your result is below your lab's 'the detection limit and this limit is unknown" class="bioageform-toggle-text">Set if negative:</span>
                                <div title="Check this box if your result is below your lab's 'the detection limit and this limit is unknown" class="negative-toggle">
                                    <label for="crp-negative" class="toggle-label">
                                        <input type="checkbox" id="crp-negative" onchange="toggleCRPInput()">
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            </div>

                            <!-- Input Group -->
                            <div class="input-group">
                                <input type="number" id="crp" name="crp" step="any" required aria-required="true" inputmode="decimal" onchange="calculateResultIfResultAlreadyCalculated()">
                                <label for="crpUnit" class="visually-hidden">Select unit for C-Reactive Protein</label>
                                <select id="crpUnit" name="crpUnit" aria-label="CRP unit" onchange="calculateResultIfResultAlreadyCalculated()">
                                    <option value="10">mg/L</option>
                                    <option value="1">mg/dL</option>
                                    <option value="10000">mg/mL</option>
                                    <option value="86.96">nmol/L</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Lymphocyte Percentage -->
                <div class="biomarker-card">
                    <div class="biomarker-card-header" aria-expanded="false">
                        Lymphocytes
                        <span class="toggle-icon">+</span>
                    </div>
                    <div class="biomarker-card-content">
                        <div class="input-group">
                            <input type="number" id="lymphocyte" name="lymphocyte" step="any" required aria-required="true" inputmode="decimal" onchange="calculateResultIfResultAlreadyCalculated()">
                            <label for="lymphocyteUnit" class="visually-hidden">Select unit for Lymphocytes</label>
                            <select id="lymphocyteUnit" name="lymphocyteUnit" aria-label="Lymphocyte unit" onchange="calculateResultIfResultAlreadyCalculated()">
                                <option value="1">%</option>
                                <option value="1">1000 cells/μL</option>
                                <option value="1">10⁹ cells/L</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Mean Corpuscular Volume -->
                <div class="biomarker-card">
                    <div class="biomarker-card-header" aria-expanded="false">
                        Mean Corpuscular Volume
                        <span class="toggle-icon">+</span>
                    </div>
                    <div class="biomarker-card-content">
                        <div class="input-group">
                            <input type="number" id="mcv" name="mcv" step="any" required aria-required="true" inputmode="decimal" onchange="calculateResultIfResultAlreadyCalculated()">
                            <label for="mcvUnit" class="visually-hidden">Select unit for MCV</label>
                            <select id="mcvUnit" name="mcvUnit" aria-label="MCV unit" onchange="calculateResultIfResultAlreadyCalculated()">
                                <option value="1">fL</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Red Cell Distribution Width -->
                <div class="biomarker-card">
                    <div class="biomarker-card-header" aria-expanded="false">
                        Red Cell Distribution Width
                        <span class="toggle-icon">+</span>
                    </div>
                    <div class="biomarker-card-content">
                        <div class="input-group">
                            <input type="number" id="rcdw" name="rcdw" step="any" required aria-required="true" inputmode="decimal" onchange="calculateResultIfResultAlreadyCalculated()">
                            <label for="rcdwUnit" class="visually-hidden">Select unit for RDW</label>
                            <select id="rcdwUnit" name="rcdwUnit" aria-label="RDW unit" onchange="calculateResultIfResultAlreadyCalculated()">
                                <option value="1">%</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Alkaline Phosphatase -->
                <div class="biomarker-card">
                    <div class="biomarker-card-header" aria-expanded="false">
                        Alkaline Phosphatase
                        <span class="toggle-icon">+</span>
                    </div>
                    <div class="biomarker-card-content">
                        <div class="input-group">
                            <input type="number" id="ap" name="ap" step="any" required aria-required="true" inputmode="decimal" onchange="calculateResultIfResultAlreadyCalculated()">
                            <label for="apUnit" class="visually-hidden">Select unit for Alkaline Phosphatase</label>
                            <select id="apUnit" name="apUnit" aria-label="AP unit" onchange="calculateResultIfResultAlreadyCalculated()">
                                <option value="1">U/L</option>
                                <option value="0.01667">μkat/L</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- White Blood Cell Count -->
                <div class="biomarker-card">
                    <div class="biomarker-card-header" aria-expanded="false">
                        White Blood Cell Count
                        <span class="toggle-icon">+</span>
                    </div>
                    <div class="biomarker-card-content">
                        <div class="input-group">
                            <input type="number" id="wbc" name="wbc" step="any" required aria-required="true" inputmode="decimal" onchange="calculateResultIfResultAlreadyCalculated()">
                            <label for="wbcUnit" class="visually-hidden">Select unit for White Blood Cell Count</label>
                            <select id="wbcUnit" name="wbcUnit" aria-label="WBC unit" onchange="calculateResultIfResultAlreadyCalculated()">
                                <option value="1">1000 cells/μL</option>
                                <option value="1">10⁹ cells/L</option>
                                <option value="1000">cells/μL</option>
                                <option value="1000">cells/mm³</option>
                            </select>
                        </div>
                    </div>
                </div>
            </fieldset>

            <!-- Calculate Button -->
            <button type="submit" class="option-button grey" aria-label="Calculate your biological age" style="margin-top: 1.5rem; max-width: 350px; ">
                <i class="fas fa-heartbeat"></i>&nbsp;Calculate My Biological&nbsp;Age
            </button>
        </form>

        <div id="phenoAgeResult" class="bioageform" data-aos="fade" data-aos-duration="700" data-aos-delay="400">
            <div id="validAgeInput">
                <div style="font-size: 1rem; color: #2c3e50; text-align: center;">Your biological age is:</div>
                <div style="font-size: 2.5rem; color: #4CAF50; font-weight: bold; text-align: center;"><span id="animatedAge">0</span></div>
                <div id="yearsText" style="font-size: 1rem; color: #2c3e50; text-align: center;">years</div>
            </div>
            <div id="ensureCorrectInputSuggestion" style="display: none; font-size: 1rem; color: #8B0000; background-color: #FAD2D2; padding: 0.5rem; text-align: center; border-radius: 5px; margin-top: 10px;">
                The calculated result seems wrong. Double-check all your input values and units. If everything looks correct, drop everything and rush to a hospital NOW!!!
                <i class="fas fa-ambulance"></i> <i class="fas fa-hospital"></i> <i class="fas fa-clinic-medical"></i>
            </div>
        </div>

        <div class="options-container" data-aos="fade" data-aos-duration="700" data-aos-delay="450">
            <button type="button" id="continueButton" class="option-button green" onclick="proceedToNextPage()">
                Next&nbsp;<i class="fas fa-arrow-right"></i>
            </button>

            <button type="button" class="option-button back-button" onclick="window.goBackOrHome()">
                <i class="fas fa-arrow-left"></i>&nbsp;Back
            </button>
        </div>
    </main>
    <!--FOOTER-->
    <!-- JavaScript -->
    <script defer>
        // Check if the URL has the query parameter "fake=1"
        const urlParams = new URLSearchParams(window.location.search);
        const isFake = urlParams.get('fake') === '1';
        const isUpdate = urlParams.get('update') === '1';
        const athlete = JSON.parse(sessionStorage.getItem('selectedAthlete'));

        //–– keep track of which fields the user actually edits (or clears)
        const touchedBiomarkers = new Set();
        ['albumin', 'creatinine', 'glucose', 'crp', 'lymphocyte', 'mcv', 'rcdw', 'ap', 'wbc']
            .forEach(id => {
                const el = document.getElementById(id);
                el.addEventListener('input', () => {
                    if (el.value.trim() === '') touchedBiomarkers.delete(id);
                    else touchedBiomarkers.add(id);

                    const card = el.closest('.biomarker-card');
                    const headerField = card.querySelector('.biomarker-card-header');
                    const iconField = headerField.querySelector('.toggle-icon');
                    if (el.value.trim() !== '') {
                        headerField.style.pointerEvents = 'none';
                        iconField.style.display = 'none';

                        expandFieldCard(card);
                    } else if (isUpdate) {
                        headerField.style.pointerEvents = '';
                        iconField.style.display = '';
                    }

                });
            });

        //–– seed from stored data
        const stored = JSON.parse(sessionStorage.getItem('biomarkerData'));
        if (stored?.Biomarkers?.[0]) {
            const latest = stored.Biomarkers[0];
            const propMap = {
                albumin: 'AlbGL',
                creatinine: 'CreatUmolL',
                glucose: 'GluMmolL',
                crp: 'CrpMgL',
                lymphocyte: 'LymPc',
                mcv: 'McvFL',
                rcdw: 'RdwPc',
                ap: 'AlpUL',
                wbc: 'Wbc1000cellsuL'
            };
            Object.entries(propMap).forEach(([id, prop]) => {
                if (latest[prop] != null && !isNaN(latest[prop])) {
                    touchedBiomarkers.add(id);
                }
            });
        }

        function updateCalculateButton() {
            const calculateButton = document.querySelector('form button[type="submit"]');
            const nextButton = document.getElementById('continueButton');

            if (nextButton.classList.contains('show')) {
                calculateButton.classList.remove('green'); // Reset style
            } else {
                calculateButton.classList.add('green'); // Apply matching style
            }
        }

        updateCalculateButton();

        let isResultCalculated = false;
        function calculateResultIfResultAlreadyCalculated() {
            if (isResultCalculated) {
                calculateResult();
            }
        }

        function correctCorrectableUnits() {
            // Albumin
            const albuminValue = parseFloat(document.getElementById('albumin').value);
            const albuminUnit = parseFloat(document.getElementById('albuminUnit').value);
            if (albuminUnit != 15.0466 && albuminValue > 300) {
                console.warn("Albumin is too high. Correcting the unit.");
                document.getElementById('albuminUnit').value = 15.0466;
            }
            else if (albuminUnit != 0.1 && albuminValue < 6) {
                console.warn("Albumin is too low. Correcting the unit.");
                document.getElementById('albuminUnit').value = 0.1;
            }
            else if (albuminUnit != 1 && albuminValue > 10 && albuminValue < 60) {
                console.warn("Albumin is too low. Correcting the unit.");
                document.getElementById('albuminUnit').value = 1;
            }

            // White Blood Cell Count (WBC)
            const wbcValue = parseFloat(document.getElementById('wbc').value);
            const wbcUnit = parseFloat(document.getElementById('wbcUnit').value);
            if (wbcUnit === 1 && wbcValue > 4000) {
                console.warn("WBC is too high. Correcting the unit.");
                document.getElementById('wbcUnit').value = 1000;
            }
            else if (wbcUnit === 1000 && wbcValue < 30) {
                console.warn("WBC is too low. Correcting the unit.");
                document.getElementById('wbcUnit').value = 1;
            }
        }

        let isFirstTimeAnimation = true; // Flag to control the first-time animation

        function calculateResult() {
            // In update mode, ensure at least one new biomarker was entered
            if (isUpdate) {
                if (touchedBiomarkers.size < 9) {
                    document.getElementById('continueButton').classList.remove('show');
                    customAlert('😱 Need to submit all 9 biomarkers!');
                    return;
                }
            }

            const markerValues = [];

            // Get age from separate Date of Birth inputs
            const yearInput = document.getElementById('dob-year').value;
            const monthInput = document.getElementById('dob-month').value;
            const dayInput = document.getElementById('dob-day').value;

            const year = yearInput ? parseInt(yearInput) : null;
            const month = monthInput ? parseInt(monthInput) - 1 : 11; // Convert to 0-based index
            const day = dayInput ? parseInt(dayInput) : 31; // Default to last day

            if (!year) {
                customAlert("Please select a year.");
                return;
            }

            const dobValue = new Date(year, month, day);  // Month is 0-based (0 = Jan), Day is 1-based (1 = 1st day, 0 = last day of previous month)
            let chronologicalAge;
            try {
                chronologicalAge = window.PhenoAge.calculateAgeFromDOB(dobValue);
                if (chronologicalAge < 0) {
                    throw new Error("Invalid Date of Birth: You cannot be born in the future.");
                }
            } catch (error) {
                customAlert(error.message);
                return;
            }

            // Add age as the first marker value
            markerValues.push(chronologicalAge);

            // Fill missing biomarker fields on update
            if (isUpdate) {
                const latestBiomarkerSet = athlete.Biomarkers.reduce((latest, current) => {
                    return new Date(current.Date) > new Date(latest.Date) ? current : latest;
                });
                const biomarkerDefaults = {
                    albumin: { val: latestBiomarkerSet.AlbGL, unit: '1' },
                    creatinine: { val: latestBiomarkerSet.CreatUmolL, unit: '1' },
                    glucose: { val: latestBiomarkerSet.GluMmolL, unit: '1' },
                    crp: { val: latestBiomarkerSet.CrpMgL, unit: '10' },
                    lymphocyte: { val: latestBiomarkerSet.LymPc, unit: '1' },
                    mcv: { val: latestBiomarkerSet.McvFL, unit: '1' },
                    rcdw: { val: latestBiomarkerSet.RdwPc, unit: '1' },
                    ap: { val: latestBiomarkerSet.AlpUL, unit: '1' },
                    wbc: { val: latestBiomarkerSet.Wbc1000cellsuL, unit: '1' }
                };
                Object.entries(biomarkerDefaults).forEach(([id, { val, unit }]) => {
                    const input = document.getElementById(id);
                    if (!input.value) {
                        input.value = val;
                        document.getElementById(id + 'Unit').value = unit;
                    }
                });
            }

            correctCorrectableUnits();

            // Get biomarker values
            for (let i = 1; i < window.PhenoAge.biomarkers.length; i++) {
                const biomarker = window.PhenoAge.biomarkers[i];
                const valueElement = document.getElementById(biomarker.id);
                const unitElement = document.getElementById(biomarker.id + 'Unit');
                const rawValue = window.PhenoAge.parseInput(valueElement.value);
                const unitConversion = parseFloat(unitElement.value);
                const unitText = unitElement.options[unitElement.selectedIndex].text;

                // Check for invalid input
                if (isNaN(rawValue)) {
                    expandFieldCard(biomarker.id);
                    customAlert(`Please enter a valid value for ${biomarker.name}.`).then(() => {
                        document.getElementById('continueButton').classList.remove('show');
                        updateCalculateButton();
                    });
                    return;
                }

                // Apply unit conversion
                let adjustedValue = rawValue / unitConversion;

                // Special handling for CRP
                if (biomarker.id === 'crp') {
                    adjustedValue = Math.log(adjustedValue);
                }

                // Special handling for lymphocytes
                if (biomarker.id === 'lymphocyte' && unitText !== '%') {
                    const wbcValueElement = document.getElementById('wbc');
                    const wbcUnitElement = document.getElementById('wbcUnit');
                    const wbcRawValue = window.PhenoAge.parseInput(wbcValueElement.value);
                    const wbcUnitConversion = parseFloat(wbcUnitElement.value);

                    if (isNaN(wbcRawValue)) {
                        expandFieldCard('wbc');
                        expandFieldCard('lymphocyte');
                        customAlert("Please provide White Blood Cell Count to calculate Lymphocyte percentage.").then(() => {
                            document.getElementById('continueButton').classList.remove('show');
                            updateCalculateButton();
                        });
                        return;
                    }

                    const wbcAdjustedValue = wbcRawValue / wbcUnitConversion;
                    adjustedValue = (adjustedValue / wbcAdjustedValue) * 100;
                }

                markerValues.push(adjustedValue);
            }

            // Calculate PhenoAge using the helper function
            const phenoAge = window.PhenoAge.calculatePhenoAge(markerValues);

            // Display the result
            const resultElement = document.getElementById('phenoAgeResult');
            const ensureCorrectInputSuggestion = document.getElementById('ensureCorrectInputSuggestion');
            const validAgeInput = document.getElementById('validAgeInput');

            // Check if the result is not infinite
            if (!isFinite(phenoAge)) {
                resultElement.style.opacity = 1; // Fade-in effect
                ensureCorrectInputSuggestion.style.display = 'block';
                validAgeInput.style.display = 'none';
                return;
            }
            else {
                ensureCorrectInputSuggestion.style.display = 'none';
                validAgeInput.style.display = 'block';
            }

            // Setting up the animated counter effect
            let displayAge = 0;
            if (isFirstTimeAnimation) {
                // Set the flag to false after the first run
                isFirstTimeAnimation = false;

                setTimeout(() => {
                    resultElement.style.opacity = 1; // Fade-in effect
                    const ageCounter = setInterval(() => {
                        displayAge += 1;
                        document.getElementById('animatedAge').innerText = displayAge.toFixed(0);
                        if (displayAge >= phenoAge) {
                            clearInterval(ageCounter);
                            document.getElementById('animatedAge').innerText = phenoAge.toFixed(1); // Set final age value

                            if (phenoAge < chronologicalAge) {
                                // Add the celebratory emoji to the "years" line
                                document.getElementById('yearsText').innerHTML = `years 🚀`;
                            }

                            // Show the Next button
                            document.getElementById('continueButton').classList.add('show');
                            updateCalculateButton();
                        }
                    }, 30);
                }, 100);
            } else {
                setTimeout(() => {
                    resultElement.style.opacity = 1; // Fade-in effect
                    // Direct update without animation
                    document.getElementById('animatedAge').innerText = phenoAge.toFixed(1);
                    document.getElementById('yearsText').innerHTML = phenoAge < chronologicalAge ? `years 🚀` : `years`;

                    document.getElementById('continueButton').classList.add('show');
                    updateCalculateButton();
                }, 100);
            }

            isResultCalculated = true;
        }

        // Mapping language or country codes to unit preferences
        const unitPreferences = {
            US: {
                albuminUnit: '0.1',       // g/dL
                creatinineUnit: '0.0113', // mg/dL
                glucoseUnit: '18.016',    // mg/dL
                crpUnit: '10',             // mg/L
                lymphocyteUnit: '1',      // %
                mcvUnit: '1',             // fL
                rcdwUnit: '1',            // %
                apUnit: '1',              // U/L
                wbcUnit: '1'              // 1000 cells/μL
            },
            GB: {
                albuminUnit: '1',         // g/L (SI unit, common in the UK)
                creatinineUnit: '1',      // µmol/L
                glucoseUnit: '1',         // mmol/L
                crpUnit: '10',            // mg/L
                lymphocyteUnit: '1',      // %
                mcvUnit: '1',             // fL
                rcdwUnit: '1',            // %
                apUnit: '1',              // U/L
                wbcUnit: '1'              // 1000 cells/μL
            },
            HU: {
                albuminUnit: '1',         // g/L
                creatinineUnit: '1',      // µmol/L
                glucoseUnit: '1',         // mmol/L
                crpUnit: '10',            // mg/L
                lymphocyteUnit: '1',      // %
                mcvUnit: '1',             // fL
                rcdwUnit: '1',            // %
                apUnit: '1',              // U/L
                wbcUnit: '1'              // 1000 cells/μL
            },
            AU: {
                albuminUnit: '1',         // g/L
                creatinineUnit: '1',      // µmol/L
                glucoseUnit: '1',         // mmol/L
                crpUnit: '10',            // mg/L
                lymphocyteUnit: '1',      // %
                mcvUnit: '1',             // fL
                rcdwUnit: '1',            // %
                apUnit: '1',              // U/L
                wbcUnit: '1'              // 1000 cells/μL
            },
            DE: {
                albuminUnit: '1',         // g/L
                creatinineUnit: '1',      // µmol/L
                glucoseUnit: '1',         // mmol/L
                crpUnit: '10',            // mg/L
                lymphocyteUnit: '1',      // %
                mcvUnit: '1',             // fL
                rcdwUnit: '1',            // %
                apUnit: '1',              // U/L
                wbcUnit: '1'              // 1000 cells/μL
            },
            FR: {
                albuminUnit: '1',         // g/L
                creatinineUnit: '1',      // µmol/L
                glucoseUnit: '1',         // mmol/L
                crpUnit: '10',            // mg/L
                lymphocyteUnit: '1',      // %
                mcvUnit: '1',             // fL
                rcdwUnit: '1',            // %
                apUnit: '1',              // U/L
                wbcUnit: '1'              // 1000 cells/μL
            },
            ES: {
                albuminUnit: '1',         // g/L
                creatinineUnit: '1',      // µmol/L
                glucoseUnit: '1',         // mmol/L
                crpUnit: '10',            // mg/L
                lymphocyteUnit: '1',      // %
                mcvUnit: '1',             // fL
                rcdwUnit: '1',            // %
                apUnit: '1',              // U/L
                wbcUnit: '1'              // 1000 cells/μL
            },
            BR: {
                albuminUnit: '1',         // g/L
                creatinineUnit: '1',      // µmol/L
                glucoseUnit: '1',         // mmol/L
                crpUnit: '10',            // mg/L
                lymphocyteUnit: '1',      // %
                mcvUnit: '1',             // fL
                rcdwUnit: '1',            // %
                apUnit: '1',              // U/L
                wbcUnit: '1'              // 1000 cells/μL
            },
            HN: {
                albuminUnit: '0.1',       // g/dL
                creatinineUnit: '0.0113', // mg/dL
                glucoseUnit: '18.016',    // mg/dL
                crpUnit: '10',            // mg/L
                lymphocyteUnit: '1',      // %
                mcvUnit: '1',             // fL
                rcdwUnit: '1',            // %
                apUnit: '1',              // U/L
                wbcUnit: '1'              // 1000 cells/μL
            },
            SG: {
                albuminUnit: '1',         // g/L
                creatinineUnit: '1',      // µmol/L
                glucoseUnit: '1',         // mmol/L
                crpUnit: '10',            // mg/L
                lymphocyteUnit: '1',      // %
                mcvUnit: '1',             // fL
                rcdwUnit: '1',            // %
                apUnit: '1',              // U/L
                wbcUnit: '1'              // 1000 cells/μL
            },
            CZ: {
                albuminUnit: '1',         // g/L
                creatinineUnit: '1',      // µmol/L
                glucoseUnit: '1',         // mmol/L
                crpUnit: '10',            // mg/L
                lymphocyteUnit: '1',      // %
                mcvUnit: '1',             // fL
                rcdwUnit: '1',            // %
                apUnit: '1',              // U/L
                wbcUnit: '1'              // 1000 cells/μL
            },
            CA: {
                albuminUnit: '1',         // g/L
                creatinineUnit: '1',      // µmol/L
                glucoseUnit: '1',         // mmol/L
                crpUnit: '10',            // mg/L
                lymphocyteUnit: '1',      // %
                mcvUnit: '1',             // fL
                rcdwUnit: '1',            // %
                apUnit: '1',              // U/L
                wbcUnit: '1'              // 1000 cells/μL
            },
            default: {
                albuminUnit: '1',         // g/L
                creatinineUnit: '1',      // µmol/L
                glucoseUnit: '1',         // mmol/L
                crpUnit: '10',            // mg/L
                lymphocyteUnit: '1',      // %
                mcvUnit: '1',             // fL
                rcdwUnit: '1',            // %
                apUnit: '1',              // U/L
                wbcUnit: '1'              // 1000 cells/μL
            }
        };

        document.addEventListener('DOMContentLoaded', function () {
            const unitSelects = document.querySelectorAll('.input-group select');
            let maxWidth = 0;

            unitSelects.forEach(select => {
                // Temporarily add the select to the body to calculate its full width
                const tempDiv = document.createElement('div');
                tempDiv.style.position = 'absolute';
                tempDiv.style.visibility = 'hidden';
                tempDiv.appendChild(select.cloneNode(true));
                document.body.appendChild(tempDiv);

                // Update maxWidth if this select's width is larger
                maxWidth = Math.max(maxWidth, tempDiv.clientWidth + 20);
                document.body.removeChild(tempDiv);
            });

            // Set the maxWidth as the min-width for each unit select
            unitSelects.forEach(select => {
                select.style.minWidth = `${maxWidth}px`;
            });

            const yearSelect = document.getElementById('dob-year');
            const currentYear = new Date().getFullYear();

            for (let year = currentYear; year >= 1908; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            }

            updateDays(); // Added line

            // Apply preferences on page load
            applyLanguagePreferences();

            if (isFake) {
                fillFakeData();
            }

            if (isUpdate) {
                hideMainProgress();

                document.getElementById('mainPageTitleH2').innerHTML = athlete.Name;
                document.getElementById('mainInstructions').innerHTML = 'Submit your latest test results. Partial biomarker submissions are <a href="https://nopara73.medium.com/lwc25-point-system-update-daa6c92120ba" target="_blank">allowed</a>.';

                // Fill out the date of birth because we'll need it for calculations, but hide it as well so the user doesn't wanna change that.
                document.getElementById('dob-year').value = athlete.DateOfBirth.Year;
                document.getElementById('dob-month').value = athlete.DateOfBirth.Month;
                document.getElementById('dob-day').value = athlete.DateOfBirth.Day;
                document.getElementById('dobFieldset').style.display = 'none';

                // Disable built-in HTML5 required checks in update mode
                document.getElementById('phenoAgeForm').setAttribute('novalidate', '');

                // Scroll the heading into view
                document.querySelector('h1').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
            else {
                updateMainProgress(2);
            }

            // Initialize collapsability based on current values (handles programmatic fills)
            ['albumin', 'creatinine', 'glucose', 'crp', 'lymphocyte', 'mcv', 'rcdw', 'ap', 'wbc']
                .forEach(fieldId => {
                    document.getElementById(fieldId).dispatchEvent(new Event('input'));
                });
            // Also honor CRP-negative checkbox state
            document.getElementById('crp-negative').dispatchEvent(new Event('change'));

            if (isUpdate) {
                // any card that's .active right now came from code, not the user —
                // so hide its toggle-icon
                document
                    .querySelectorAll('.biomarker-card.active .toggle-icon')
                    .forEach(icon => icon.style.display = 'none');
            }

            updateModeFormInitializerUnique();
        });

        function updateModeFormInitializerUnique() {
            if (!isUpdate) return;

            const idMapUnique = {
                AlbGL: 'albumin',
                CreatUmolL: 'creatinine',
                GluMmolL: 'glucose',
                CrpMgL: 'crp',
                LymPc: 'lymphocyte',
                McvFL: 'mcv',
                RdwPc: 'rcdw',
                AlpUL: 'ap',
                Wbc1000cellsuL: 'wbc'
            };
            Object.values(idMapUnique).forEach(bioId => {
                document.getElementById(bioId).value = '';
            });

            // collapse every card
            document.querySelectorAll('.biomarker-card.active').forEach(card => {
                const hdr = card.querySelector('.biomarker-card-header');
                const icn = hdr.querySelector('.toggle-icon');
                const cnt = card.querySelector('.biomarker-card-content');
                card.classList.remove('active');
                hdr.setAttribute('aria-expanded', 'false');
                icn.style.display = '';
                cnt.style.maxHeight = '0';
                cnt.style.paddingTop = '0';
                cnt.style.paddingBottom = '0';
            });

            // cos this shitty function wiped it all
            if (isFake) {
                fillFakeData();
            }

            // refill only saved biomarkers
            const stored = JSON.parse(sessionStorage.getItem('biomarkerData'));
            const entry = stored?.Biomarkers?.[0];
            if (entry) {
                Object.keys(entry).forEach(prop => {
                    const id = idMapUnique[prop];
                    if (id) {
                        document.getElementById(id).value = entry[prop];
                        expandFieldCard(id);
                    }
                });
                // hide toggle icons on expanded cards
                document.querySelectorAll('.biomarker-card.active .toggle-icon')
                    .forEach(i => i.style.display = 'none');
            }
        }

        window.addEventListener('pageshow', updateModeFormInitializerUnique);

        // Detect and apply preferences based on language
        function applyLanguagePreferences() {
            const language = navigator.language || 'default'; // e.g., 'en-US'
            const countryMatch = language.match(/[-_](\w{2})$/); // Extract country code)
            const countryCode = countryMatch ? countryMatch[1].toUpperCase() : '';

            const preferences = unitPreferences[countryCode] || unitPreferences.default;

            // Apply preferences to unit select elements
            for (const [unitId, unitValue] of Object.entries(preferences)) {
                const unitSelect = document.getElementById(unitId);
                if (unitSelect) {
                    unitSelect.value = unitValue;
                }
            }
        }

        function proceedToNextPage() {
            if (isUpdate && touchedBiomarkers.size === 0) {
                customAlert('😱 No new biomarker data entered! Cannot proceed!');
                return;
            }

            const yearInput = document.getElementById('dob-year').value;
            const monthInput = document.getElementById('dob-month').value;
            const dayInput = document.getElementById('dob-day').value;

            const year = yearInput ? parseInt(yearInput) : null;
            const month = monthInput ? parseInt(monthInput) - 1 : 11; // Convert to 0-based index
            const day = dayInput ? parseInt(dayInput) : 31; // Default to last day

            // Collect only biomarkers the user actually touched
            const entry = {
                Date: new Date().toISOString().split('T')[0] // Current date in YYYY-MM-DD format
            };
            // only assign if the user actually touched that field:
            if (touchedBiomarkers.has('albumin')) {
                entry.AlbGL = parseFloat(document.getElementById('albumin').value)
                    / parseFloat(document.getElementById('albuminUnit').value);
            }
            if (touchedBiomarkers.has('creatinine')) {
                entry.CreatUmolL = parseFloat(document.getElementById('creatinine').value)
                    / parseFloat(document.getElementById('creatinineUnit').value);
            }
            if (touchedBiomarkers.has('glucose')) {
                entry.GluMmolL = parseFloat(document.getElementById('glucose').value)
                    / parseFloat(document.getElementById('glucoseUnit').value);
            }
            if (touchedBiomarkers.has('crp')) {
                entry.CrpMgL = (parseFloat(document.getElementById('crp').value)
                    / parseFloat(document.getElementById('crpUnit').value)) * 10; // Multiply by 10 because we assigned 10x multiplier for mg/L as the base unit
            }
            if (touchedBiomarkers.has('lymphocyte')) {
                entry.LymPc = parseFloat(document.getElementById('lymphocyte').value);
            }
            if (touchedBiomarkers.has('mcv')) {
                entry.McvFL = parseFloat(document.getElementById('mcv').value);
            }
            if (touchedBiomarkers.has('rcdw')) {
                entry.RdwPc = parseFloat(document.getElementById('rcdw').value);
            }
            if (touchedBiomarkers.has('ap')) {
                entry.AlpUL = parseFloat(document.getElementById('ap').value);
            }
            if (touchedBiomarkers.has('wbc')) {
                entry.Wbc1000cellsuL = parseFloat(document.getElementById('wbc').value);
            }

            const biomarkerData = {
                DateOfBirth: {
                    Year: year,
                    Month: month + 1, // Adjust month to 1-based index
                    Day: day
                },
                Biomarkers: [entry]
            };

            // Store the data in sessionStorage
            const chronoAge = window.PhenoAge.calculateAgeFromDOB(new Date(year, month, day));
            const bioAge = parseFloat(document.getElementById('animatedAge').innerText);
            const chronoBioDifference = bioAge - chronoAge;
            sessionStorage.setItem('chronoBioDifference', chronoBioDifference.toFixed(2));

            sessionStorage.setItem('biomarkerData', JSON.stringify(biomarkerData));

            if (isUpdate) {
                window.location.href = '/play/proof-upload.html';
            } else {
                window.location.href = '/onboarding/convergence.html';
            }
        }
        function fillFakeData() {
            // Set fake Date of Birth
            document.getElementById('dob-year').value = 1966;
            document.getElementById('dob-month').value = 7;
            document.getElementById('dob-day').value = 12;

            // Set fake values for all input fields
            document.getElementById('albumin').value = 45; // g/L
            document.getElementById('albuminUnit').value = 1; // g/L

            document.getElementById('creatinine').value = 80; // µmol/L
            document.getElementById('creatinineUnit').value = 1; // µmol/L

            document.getElementById('glucose').value = 4.5; // mmol/L
            document.getElementById('glucoseUnit').value = 1; // mmol/L

            document.getElementById('crp').value = 1.8; // mg/L
            document.getElementById('crpUnit').value = 10; // mg/L

            document.getElementById('lymphocyte').value = 39; // %
            document.getElementById('lymphocyteUnit').value = 1; // %

            document.getElementById('mcv').value = 85; // fL
            document.getElementById('mcvUnit').value = 1; // fL

            document.getElementById('rcdw').value = 11; // %
            document.getElementById('rcdwUnit').value = 1; // %

            document.getElementById('ap').value = 12; // U/L
            document.getElementById('apUnit').value = 1; // U/L

            document.getElementById('wbc').value = 6; // 1000 cells/μL
            document.getElementById('wbcUnit').value = 1; // 1000 cells/μL

            // mark all biomarkers as touched in fake mode and expand them
            ['albumin', 'creatinine', 'glucose', 'crp', 'lymphocyte', 'mcv', 'rcdw', 'ap', 'wbc']
                .forEach(id => {
                    touchedBiomarkers.add(id);
                    expandFieldCard(id);
                });

        }

        function updateDays() {
            const year = parseInt(document.getElementById('dob-year').value);
            const month = parseInt(document.getElementById('dob-month').value);
            const daySelect = document.getElementById('dob-day');

            // Clear existing options
            daySelect.innerHTML = '<option value="" disabled selected>Select Day</option>';

            if (month) {
                const monthIndex = month - 1; // Adjust to 0-based index
                const tempYear = year || 2001; // Use selected year or default
                const lastDay = new Date(tempYear, month, 0).getDate(); // Month is 0-based (0 = Jan), Day is 1-based (1 = 1st day, 0 = last day of previous month)
                for (let day = 1; day <= lastDay; day++) {
                    const option = document.createElement('option');
                    option.value = day;
                    option.textContent = day;
                    daySelect.appendChild(option);
                }
                daySelect.value = lastDay;
            } else {
                // Default to 31 days
                for (let day = 1; day <= 31; day++) {
                    const option = document.createElement('option');
                    option.value = day;
                    option.textContent = day;
                    daySelect.appendChild(option);
                }
                daySelect.value = 31;
            }
        }

        document.getElementById('dob-year').addEventListener('change', updateDays);
        document.getElementById('dob-month').addEventListener('change', updateDays);

        function toggleCRPInput() {
            const crpInput = document.getElementById('crp');
            const crpUnit = document.getElementById('crpUnit');
            const crpNegativeCheckbox = document.getElementById('crp-negative');

            if (crpNegativeCheckbox.checked) {
                crpInput.value = 1; // Set value to 1
                crpUnit.value = 10; // Set unit to mg/L
                crpInput.disabled = true; // Disable input field
                crpUnit.disabled = true; // Disable unit selector
                touchedBiomarkers.add('crp');
            } else {
                crpInput.disabled = false; // Enable input field
                crpUnit.disabled = false; // Enable unit selector
            }

            calculateResultIfResultAlreadyCalculated();

            const card = document.getElementById('crp').closest('.biomarker-card');
            const crpHeaderField = card.querySelector('.biomarker-card-header');
            const crpIconField = crpHeaderField.querySelector('.toggle-icon');
            if (crpNegativeCheckbox.checked || document.getElementById('crp').value.trim() !== '') {
                crpHeaderField.style.pointerEvents = 'none';
                crpIconField.style.display = 'none';

                expandFieldCard(card);
            } else if (isUpdate) {
                crpHeaderField.style.pointerEvents = '';
                crpIconField.style.display = '';
            }
        }

        // Hide month/day & privacy note when age < 18
        function checkMinor() {
            const y = parseInt(document.getElementById('dob-year').value, 10);
            if (!y) return;
            const m = parseInt(document.getElementById('dob-month').value, 10) - 1;
            const dVal = document.getElementById('dob-day').value;
            const d = dVal ? parseInt(dVal, 10) : 31;

            const today = new Date();
            let age = today.getFullYear() - y;
            const mm = today.getMonth() - m;
            if (mm < 0 || (mm === 0 && today.getDate() < d)) age--;

            const hide = age < 18;
            if (hide) {
                document.getElementById('dob-month').value = '12';
                document.getElementById('dob-day').value = '31';
            }
            ['dob-month-label', 'dob-month', 'dob-day-label', 'dob-day', 'privacyNote']
                .forEach(id => {
                    const el = document.getElementById(id);
                    el.style.display = hide ? 'none' : '';
                });
        }

        // Re-run on any DOB change & on page load
        ['dob-year', 'dob-month', 'dob-day']
            .forEach(id => document.getElementById(id)
                .addEventListener('change', checkMinor)
            );
        document.addEventListener('DOMContentLoaded', checkMinor);

        // Wire up all biomarker‐card headers
        document.querySelectorAll('.biomarker-card-header').forEach(header => {
            header.addEventListener('click', function handler() {
                const card = header.parentNode;
                const content = card.querySelector('.biomarker-card-content');
                const icon = header.querySelector('.toggle-icon');

                if (!isUpdate) {
                    if (!card.classList.contains('active')) {
                        card.classList.add('active');
                        header.setAttribute('aria-expanded', 'true');

                        content.style.maxHeight = content.scrollHeight + 'px';
                        content.style.paddingTop = '0.75rem';
                        content.style.paddingBottom = '0.75rem';
                        header.style.pointerEvents = 'none';
                        header.style.cursor = 'default';
                        icon.style.display = 'none';
                    }
                    return;
                }

                // update mode: full toggle with icon swap
                const isActive = card.classList.toggle('active');
                header.setAttribute('aria-expanded', isActive);

                icon.textContent = isActive ? '−' : '+';
                icon.style.display = '';
                if (isActive) {
                    content.style.maxHeight = content.scrollHeight + 'px';
                    content.style.paddingTop = '0.75rem';
                    content.style.paddingBottom = '0.75rem';
                } else {
                    content.style.maxHeight = '0';
                    content.style.paddingTop = '0';
                    content.style.paddingBottom = '0';
                }
            });
        });

        /**
         * Expands the biomarker card containing the given input field.
         *
         * @param {string|HTMLElement} field - The ID of the input field, or the field element itself.
         */
        function expandFieldCard(field) {
            // Get the input element
            const input = typeof field === 'string'
                ? document.getElementById(field)
                : field;
            if (!input) return;

            // Find its enclosing card
            const card = input.closest('.biomarker-card');
            if (!card) return;

            // If not already expanded, open it
            if (!card.classList.contains('active')) {
                const header = card.querySelector('.biomarker-card-header');

                card.classList.add('active');
                if (header) header.setAttribute('aria-expanded', 'true');

                // Animate the content area open
                const content = card.querySelector('.biomarker-card-content');
                content.style.maxHeight = content.scrollHeight + 'px';
                content.style.paddingTop = '0.75rem';
                content.style.paddingBottom = '0.75rem';

                // Handle the toggle icon and header behavior
                const icon = card.querySelector('.toggle-icon');

                if (!isUpdate) {
                    // In non-update mode: hide the icon and disable further clicks
                    if (icon) icon.style.display = 'none';
                    if (header) {
                        header.style.pointerEvents = 'none';
                        header.style.cursor = 'default';
                    }
                } else {
                    // In update mode: show a minus icon
                    if (icon) {
                        icon.textContent = '−';
                        icon.style.display = '';

                        if (touchedBiomarkers.has(input.id)) {
                            icon.style.display = 'none';
                        }
                    }
                }
            }
        }

        // Let the browser show its validation bubbles, but expand the card first
        const form = document.getElementById('phenoAgeForm');

        form.addEventListener('invalid', e => {
            // invalid fires during the capture phase before the bubble appears
            expandFieldCard(e.target);
        }, true);

        // On submit, defer to browser validation; only when the form is fully valid do we preventDefault and run calculateResult()
        form.addEventListener('submit', function (e) {
            // prevent normal submit
            e.preventDefault();

            // calculate
            calculateResult();

            // let browser show validation bubbles (invalid events expand cards)
            if (!this.reportValidity()) {
                return;
            }

            // all valid → scroll the Calculate button into view
            const calculateButton = this.querySelector('button[type="submit"]');
            if (calculateButton) {
                calculateButton.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        });
    </script>
</body>
</html>