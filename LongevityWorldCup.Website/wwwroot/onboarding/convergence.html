<!DOCTYPE html>
<html lang="en">
<head>
    <!--HEAD-->
    <link rel="stylesheet" href="https://unpkg.com/cropperjs@1.5.13/dist/cropper.min.css">
    <link rel="stylesheet" href="/css/bioageform.css">
    <style>
        /* Hide the join-game button in the header */
        .join-game {
            display: none;
        }

        .autocomplete-container {
            position: relative;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: linear-gradient(135deg, #cccccc, #e0e0e0); /* Subtle disabled gradient */
            box-shadow: none; /* Remove shadows for disabled buttons */
        }

        #division {
            cursor: pointer;
        }

        .option-button.already-have {
            background: var(--main-action-color);
            transition: background 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Subtle shadow */
        }

            .option-button.already-have:hover {
                background: var(--main-action-selected-color);
                transform: scale(1.03); /* Slight enlarge effect */
                box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2); /* Enhanced shadow on hover */
            }

        /* Responsive adjustments */
        @media (max-width: 600px) {
            .option-button {
                font-size: 1rem; /* Adjusted for smaller screens */
                padding: 0.8rem 1.5rem; /* Adjust padding for smaller buttons */
            }
        }

        #flag {
            margin-bottom: 0; /* Reset any margin added here */
        }

        .error-message {
            color: red;
            font-size: 0.9rem;
            margin-top: 0.5rem;
            display: block;
        }

        .char-counter {
            font-size: 0.9rem;
            color: green;
            position: absolute;
            bottom: 10px;
            right: 10px;
        }

            .char-counter.hidden {
                display: none;
            }

        .autocomplete-items {
            position: absolute;
            top: 100%;
            left: 0;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: white;
            z-index: 9999;
            max-height: 150px;
            overflow-y: auto;
            width: 100%;
        }

            .autocomplete-items .autocomplete-active {
                background-color: #0069d9;
                color: var(--light-text-color);
            }

            .autocomplete-items div {
                padding: 10px;
                cursor: default;
                border-bottom: 1px solid #eee;
            }

                .autocomplete-items div:hover {
                    background-color: #0069d9; /* Blue hover color from the picture */
                    color: var(--light-text-color); /* Ensure text is visible on blue background */
                }
        /* Add a new class for the pointer cursor */
        .clickable {
            cursor: pointer;
        }

        /* Style for the cropping image */
        #cropperImage {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 0 auto;
        }

        #proofImageContainer div {
            position: relative;
            display: inline-block;
            margin: 0.5rem;
        }

        #proofImageContainer img {
            max-width: 200px;
            border: 2px solid var(--dark-text-color);
            border-radius: 8px;
        }

        #proofImageContainer button {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: rgba(255, 0, 0, 0.7);
            color: var(--light-text-color);
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        /* Must use important because back button styles applied later. Without important it doesn't overwrite it. */
        .back-button {
            margin-right: auto !important;
            margin-left: 0 !important; /* Resets left margin */
        }

        #profileUploadSection {
            width: 100%;
        }
    </style>
</head>
<body>
    <!--HEADER-->
    <main>
        <!--MAIN-PROGRESS-BAR-->
        <h2 data-aos="fade" data-aos-duration="700" data-aos-delay="400">1. Character Creation</h2>
        <form id="descriptionForm" class="bioageform" data-aos="fade" data-aos-duration="700" data-aos-delay="450">
            <div style="text-align: center;">
                <picture id="illustrationPicture" style="display:''">
                    <source srcset="../assets/content-images/reaper.webp" type="image/webp">
                    <source srcset="../assets/content-images/reaper.jpg" type="image/jpeg">
                    <img id="illustrationImage" src="../assets/content-images/reaper.jpg" alt="Grim Reaper" class="illustration" loading="lazy">
                </picture>
                <img style="display:none" id="profileImage" src="" alt="Profile Picture" class="illustration" loading="lazy">
            </div>
            <!--SUB-PROGRESS-BAR-->
            <div id="shadowsText" style="display:none">
                <p>
                    In the shadows beyond our world, <strong>Death awaits</strong>, silent and relentless. It lurks at the edge of every breath, ready to claim its due.
                    In these darkening times, we need a <strong>hero to rise</strong> — a mind sharp enough to craft a plan, a heart bold enough to take a stand.
                    Death will come — but who will stand in its path?<br />
                </p>
                <p>
                    <em>Could it be you?</em>
                </p>
            </div>

            <div id="whyText" style="display:none">
                <p>He who has a <em>why</em> can bear almost any <em>how.</em></p>
            </div>

            <div id="privacyText" style="display:none">
                <p><strong>Privacy is your ability to selectively reveal yourself to the world.</strong></p>
                <p>
                    Cristiano Ronaldo is one of the greatest football players of all time. Put yourself into his boots. You must work hard, of course, but your job doesn't end with honing your skills. You also need to display them in front of millions of people. <em>There’s no sport without spectators.</em>
                </p>
                <p>
                    So, does he lack privacy? <strong>No</strong>, he made a decision to selectively reveal himself to the world.
                </p>
            </div>

            <div id="profilePicText" style="display:none">
                <p>Next, provide your profile picture. Smiling is optional!</p>
            </div>

            <div id="proofText" style="display:none">
                <p>Upload <strong>image proofs</strong> of your biomarkers (e.g., screenshots of PDF results or photos of physical documents).</p>
                <span class="smaller-text">
                    These images will be <strong>public</strong>, so you're encouraged to censor any irrelevant information.
                </span>
            </div>

            <div id="finalDetailsText" style="display:none">
                <p style='text-align: center; font-weight: bold;'>Complete Your Profile</p>
            </div>
            <div id="congratsText" style="display:none">
                <p>Congrats! All that's left to do is to provide an email where we can reach you about your application.</p>
            </div>
        </form>

        <form id="inputForm" class="bioageform" data-aos="fade" data-aos-duration="700" data-aos-delay="500">
            <fieldset id="personalDetails">
                <!-- Name Field -->
                <label for="name">Name</label>
                <input type="text" id="name" name="name" required aria-required="true" placeholder="Real name or cyber alias — your call">
                <span id="nameError" class="error-message"></span>

                <!-- Division Field -->
                <label for="division">Division</label>
                <select id="division" name="division" required aria-required="true">
                    <!-- Options will be populated dynamically -->
                </select>

                <!-- Flag Field with Autocomplete -->
                <label for="flag">Flag</label>
                <div class="autocomplete-container">
                    <input type="text" id="flag" name="flag" required aria-required="true" autocomplete="off" placeholder="Cyberspace">
                    <span id="flagError" class="error-message"></span>
                </div>
            </fieldset>
            <div id="privacyDetails">
                <p>
                    <strong>It's now your turn to make that decision.</strong>
                </p>
                <p>
                    <span class="smaller-text">
                        Top-ranked longevity athletes will occasionally be asked to give an interview before their results are posted. Declining means no spot on the leaderboard. By proceeding, you agree to this.
                    </span>
                </p>
            </div>
            <div id="profileUploadSection">
                <div id="uploadPart" style="display:block">
                    <p><strong>Upload a clear headshot:</strong></p>
                    <ol class="smaller-text" style="padding-left: 20px; line-height: 1.6;">
                        <li>It must be you.</li>
                        <li>Face the camera directly.</li>
                        <li>Include head and shoulders.</li>
                    </ol>
                    <div style="display: flex; flex-direction: column; align-items: center; margin-top: 1rem;">
                        <input type="file" id="profilePicInput" accept="image/*" style="display: none;">
                        <button type="button" id="uploadButton" class="option-button">Upload Profile Picture</button>
                    </div>
                </div>
                <div id="croppingPart" style="display:none">
                    <img id="cropperImage" src="" style="max-width: 100%; display: block; margin: 0 auto;">
                    <button type="button" id="cropButton" class="option-button" style="margin-top: 1rem; display: block; margin: 1rem auto 0;">
                        Crop and Save
                    </button>
                </div>
            </div>
            <div id="proofUploadSection" style="width:90%;">
                <div style="display: flex; flex-direction: column; align-items: center; margin-top: 1rem;">
                    <input type="file" id="proofPicInput" accept="image/*" style="display: none;" multiple>
                    <button type="button" id="uploadProofButton" class="option-button">Upload Proof Images</button>
                </div>
            </div>
            <fieldset id="finalDetails">
                <!-- Link to Personal Page (Optional) -->
                <label for="personalLink">Link (Optional)</label>
                <input type="url" id="personalLink" name="personalLink" placeholder="https://yourwebsite.com">
                <p style="margin-top: 0.5rem; color: #555;">
                    Provide a link to your personal page, social media profile, or any other online presence you wish to advertise.
                </p>

                <!-- Media Contact (Required) -->
                <label for="mediaContact">Media Contact (Required)</label>
                <input id="mediaContact" name="mediaContact" required aria-required="true" placeholder="media@coolpeopleonly.com">

                <p style="margin-top: 0.5rem; color: #555;">
                    <span class="smaller-text">
                        Please provide a media contact email. Be cautious about using your personal email address. It is recommended to create a dedicated email (e.g.: <a href="https://protonmail.com" target="_blank" rel="noopener">ProtonMail</a>) or use a social media account like Instagram or Twitter if your messages are open to the public.
                    </span>
                </p>
            </fieldset>
            <fieldset id="applyDetails">
                <!-- Email Field -->
                <legend for="accountEmail">Contact Email</legend>
                <input type="email" id="accountEmail" name="accountEmail" required aria-required="true" placeholder="pizza_lover@hungry.com">
            </fieldset>

            <!-- New WHY Field (Initially Hidden) -->
            <div id="whyField" style="width:90%; display: none; position: relative;">
                <label for="why">What drives you forward?</label>
                <textarea id="why" name="why" rows="5" placeholder="Share your motivation here..."></textarea>
                <div id="whyCharCounter" class="char-counter">0/250</div>
            </div>

            <!-- Proof Image Container -->
            <fieldset id="proofImageContainer" style="text-align: center; margin-top: 1rem;"></fieldset>

            <div class="options-container">
                <button type="button" class="option-button already-have" id="nextButton" aria-label="Proceed to the next stage">Next</button>
                <button type="button" class="option-button back-button" id="backButton">
                    <i class="fas fa-arrow-left"></i>&nbsp;Back
                </button>
            </div>
        </form>
    </main>
    <!--FOOTER-->
    <!-- JavaScript -->
    <script src="/js/divisionIcons.js"></script>
    <script>
        var currentStage = 1;
        let profilePic = null;
        let proofPics = [];

        // Update the progress bar to the appropriate stage
        // Assuming updateMainProgress and updateSubProgress are defined elsewhere
        updateMainProgress(3);
        updateSubProgress(1);

        function updateUploadButtons() {
            const uploadProfileButton = document.getElementById('uploadButton');
            const uploadProofButton = document.getElementById('uploadProofButton');
            const cropAndSaveButton = document.getElementById('cropButton'); // For the crop and save action
            const nextButton = document.getElementById('nextButton');

            // Toggle "already-have" class for "Upload Profile Picture" button
            if (nextButton && nextButton.classList.contains('disabled-button')) {
                uploadProfileButton.classList.add('already-have');
                cropAndSaveButton.classList.add('already-have');
                uploadProofButton.classList.add('already-have');
            } else {
                uploadProfileButton.classList.remove('already-have');
                cropAndSaveButton.classList.remove('already-have');
                uploadProofButton.classList.remove('already-have');
            }
        }

        function collectApplicantData() {
            // Get the data from the form fields
            const name = document.getElementById('name').value.trim();
            const division = document.getElementById('division').value.trim();
            const flag = document.getElementById('flag').value.trim();
            const why = document.getElementById('why').value.trim();
            const mediaContact = document.getElementById('mediaContact').value.trim();
            const accountEmail = document.getElementById('accountEmail').value.trim();
            const personalLink = document.getElementById('personalLink').value.trim();

            // Use the global variables `profilePic` and `proofPics` directly

            // Get the biomarker data from localStorage
            const biomarkerData = JSON.parse(localStorage.getItem('biomarkerData'));
            if (!biomarkerData) {
                alert('Biomarker data is missing. Please complete the biomarker form.');
                return;
            }
            console.log(biomarkerData);
            // Create the applicant data object
            const applicantData = {
                name: name,
                division: division,
                flag: flag,
                why: why,
                mediaContact: mediaContact,
                accountEmail: accountEmail,
                personalLink: personalLink,
                dateOfBirth: biomarkerData.DateOfBirth,
                biomarkers: biomarkerData.Biomarkers,
                profilePic: profilePic, // Base64 string
                proofPics: proofPics // Array of Base64 strings
            };

            return applicantData;
        }

        // Function to update the UI based on the current stage
        function goToStage(stage) {
            // Clear visibility on all main form sections
            document.getElementById('shadowsText').style.display = 'none';
            document.getElementById('whyText').style.display = 'none';
            document.getElementById('privacyText').style.display = 'none';
            document.getElementById('profilePicText').style.display = 'none';
            document.getElementById('proofText').style.display = 'none';
            document.getElementById('finalDetailsText').style.display = 'none';
            document.getElementById('congratsText').style.display = 'none';

            document.getElementById('personalDetails').style.display = 'none';
            document.getElementById('privacyDetails').style.display = 'none';
            document.getElementById('profileUploadSection').style.display = 'none';
            document.getElementById('proofUploadSection').style.display = 'none';
            document.getElementById('whyField').style.display = 'none';
            document.getElementById('proofImageContainer').style.display = 'none';
            document.getElementById('finalDetails').style.display = 'none';
            document.getElementById('applyDetails').style.display = 'none';

            // Reset the illustrationImage to be clickable or not based on stage
            const illustrationImage = document.getElementById('illustrationImage');
            const illustrationPicture = document.getElementById('illustrationPicture');
            illustrationPicture.style.display = '';
            const profileImage = document.getElementById('profileImage');
            profileImage.style.display = 'none';
            const webpSource = illustrationPicture.querySelector('source[type="image/webp"]');
            const jpegSource = illustrationPicture.querySelector('source[type="image/jpeg"]');

            function updateIllustration(imageName, format, webpSource, jpegSource, illustrationImage) {
                webpSource.srcset = `../assets/content-images/${imageName}.webp`;
                jpegSource.srcset = `../assets/content-images/${imageName}.${format}`;
                illustrationImage.src = `../assets/content-images/${imageName}.${format}`;
            }

            const nextButton = document.getElementById('nextButton');

            // Remove 'clickable' class initially
            illustrationImage.classList.remove('clickable');

            switch (stage) {
                case 1:
                    // Stage 1: Character Creation
                    document.querySelector('h2').textContent = "1. Character Creation";
                    updateIllustration("reaper", "jpg", webpSource, jpegSource, illustrationImage);
                    illustrationImage.alt = "Grim Reaper";
                    illustrationImage.loading = "lazy";
                    document.getElementById('shadowsText').style.display = '';
                    document.getElementById('personalDetails').style.display = '';
                    nextButton.innerHTML = 'Next&nbsp;<i class="fas fa-arrow-right"></i>';
                    nextButton.setAttribute('type', 'button');
                    updateSubProgress(1);

                    // Disable Next button initially
                    nextButton.disabled = true;
                    nextButton.classList.add('disabled-button');

                    // Add event listeners for validation
                    const nameInput = document.getElementById('name');
                    const flagInput = document.getElementById('flag');
                    const divisionSelect = document.getElementById('division');

                    nameInput.addEventListener('input', checkFormValidityStage1);
                    flagInput.addEventListener('input', checkFormValidityStage1);

                    nameInput.addEventListener('blur', validateStage1Inputs);
                    flagInput.addEventListener('blur', validateStage1Inputs);

                    divisionSelect.addEventListener('click', validateStage1Inputs);
                    flagInput.addEventListener('input', validateStage1Inputs);

                    function validateStage1Inputs() {
                        const nameValue = nameInput.value.trim();
                        const nameValidationResult = validateName(nameValue);
                        const nameError = document.getElementById('nameError');

                        if (!nameValidationResult.valid) {
                            nameError.textContent = nameValidationResult.error;
                        } else {
                            nameError.textContent = '';
                        }

                        const divisionSelected = divisionSelect && divisionSelect.value.trim() !== '';

                        // Only validate flag if it's not focused
                        if (document.activeElement === flagInput) {
                            const flagError = document.getElementById('flagError');
                            flagError.textContent = '';
                        }
                        else {
                            const flagValue = flagInput.value.trim();
                            const flagValidationResult = validateFlag(flagValue);
                            const flagError = document.getElementById('flagError');

                            if (!flagValidationResult.valid) {
                                flagError.textContent = flagValidationResult.error;
                            } else {
                                flagError.textContent = '';
                            }
                        }
                    }

                    // Run checkFormValidityStage1 initially
                    checkFormValidityStage1();
                    break;
                case 2:
                    // Stage 2: Finding Your Why
                    document.querySelector('h2').textContent = "2. Finding Your Why";
                    updateIllustration("why", "jpg", webpSource, jpegSource, illustrationImage);
                    illustrationImage.alt = "Eye";
                    illustrationImage.loading = "lazy";
                    document.getElementById('whyText').style.display = '';
                    document.getElementById('whyField').style.display = 'block';
                    nextButton.innerHTML = 'Next&nbsp;<i class="fas fa-arrow-right"></i>';
                    nextButton.setAttribute('type', 'button');
                    updateSubProgress(2);

                    // Disable Next button initially
                    nextButton.disabled = true;
                    nextButton.classList.add('disabled-button');

                    // Add event listener for validation
                    const whyInput = document.getElementById('why');
                    whyInput.addEventListener('input', checkFormValidityStage2);
                    checkFormValidityStage2(); // Initialize character counter

                    // Run checkFormValidityStage2 initially
                    checkFormValidityStage2();
                    break;
                case 3:
                    // Stage 3: The Price of Glory
                    document.querySelector('h2').textContent = "3. The Price of Glory";
                    updateIllustration("cr7", "jpg", webpSource, jpegSource, illustrationImage);
                    illustrationImage.alt = "Cristiano Ronaldo";
                    illustrationImage.loading = "lazy";
                    document.getElementById('privacyText').style.display = '';
                    document.getElementById('privacyDetails').style.display = '';
                    // In the goToStage function, within case 3, replace the existing line with the following:
                    nextButton.innerHTML = 'Next&nbsp;<i class="fas fa-arrow-right"></i>';
                    nextButton.setAttribute('type', 'button');
                    updateSubProgress(3);
                    nextButton.textContent = 'Bring it on!';

                    // Enable Next button
                    nextButton.disabled = false;
                    nextButton.classList.remove('disabled-button');
                    break;
                case 4:
                    // Stage 4: Almost There
                    document.querySelector('h2').textContent = "4/a. Almost There";
                    updateIllustration("headshot", "jpg", webpSource, jpegSource, illustrationImage);
                    illustrationImage.alt = "Headshot";
                    illustrationImage.loading = "lazy";
                    document.getElementById('profilePicText').style.display = '';
                    document.getElementById('profileUploadSection').style.display = '';

                    illustrationImage.classList.add('clickable');
                    nextButton.innerHTML = 'Next&nbsp;<i class="fas fa-arrow-right"></i>';
                    nextButton.setAttribute('type', 'button');
                    updateSubProgress(4);

                    // Disable Next button initially
                    nextButton.disabled = true;
                    nextButton.classList.add('disabled-button');

                    // Check if there is a profile picture in the global variable
                    if (profilePic) {
                        illustrationPicture.style.display = 'none';
                        profileImage.style.display = '';
                        profileImage.src = profilePic;
                        // Enable Next button if profile picture exists
                        nextButton.disabled = false;
                        nextButton.classList.remove('disabled-button');
                    }

                    // Attach event listeners for upload
                    attachUploadEventListeners();
                    break;
                case 5:
                    // Stage 5: Don't Trust Verify
                    document.querySelector('h2').textContent = "4/b. Don't Trust Verify";
                    updateIllustration("proof", "jpg", webpSource, jpegSource, illustrationImage);
                    illustrationImage.alt = "Proof Image";
                    illustrationImage.loading = "lazy";
                    document.getElementById('proofText').style.display = '';
                    document.getElementById('proofUploadSection').style.display = '';

                    illustrationImage.classList.remove('clickable');
                    nextButton.innerHTML = 'Next&nbsp;<i class="fas fa-arrow-right"></i>';
                    nextButton.setAttribute('type', 'button');
                    nextButton.classList.add("disabled-button");

                    // Attach event listener to the Upload Proof button
                    const uploadProofButton = document.getElementById('uploadProofButton');
                    if (uploadProofButton && !uploadProofButton.hasAttribute('data-listener')) {
                        uploadProofButton.addEventListener('click', function () {
                            document.getElementById('proofPicInput').click();
                        });
                        uploadProofButton.setAttribute('data-listener', 'true');
                    }

                    // Handle the image upload (without cropping)
                    const proofPicInput = document.getElementById('proofPicInput');
                    if (proofPicInput && !proofPicInput.hasAttribute('data-listener')) {
                        proofPicInput.addEventListener('change', function (event) {
                            const files = event.target.files;
                            if (files.length > 0) {
                                // Limit the total number of images to 9
                                if (proofPics.length + files.length > 9) {
                                    alert('You can upload a maximum of 9 images.');
                                    return;
                                }

                                for (let i = 0; i < files.length; i++) {
                                    const file = files[i];
                                    const reader = new FileReader();
                                    reader.onload = function (e) {
                                        proofPics.push(e.target.result);
                                        // Update the display
                                        updateProofImageContainer();
                                        // Check proof images
                                        checkProofImages();
                                    };
                                    reader.readAsDataURL(file);
                                }
                            }
                            // Reset the file input's value to allow re-uploading the same file if needed
                            document.getElementById('proofPicInput').value = "";
                        });
                        proofPicInput.setAttribute('data-listener', 'true');
                    }

                    document.getElementById('proofImageContainer').style.display = 'block';

                    // Display any existing proof images
                    updateProofImageContainer();

                    // Disable Next button initially
                    nextButton.disabled = true;
                    nextButton.classList.add('disabled-button');

                    // Check if proof images already exist
                    checkProofImages();
                    break;
                case 6:
                    // Stage 6: Final Details
                    document.querySelector('h2').textContent = "5. Final Details";
                    updateIllustration("finish", "jpg", webpSource, jpegSource, illustrationImage);
                    illustrationImage.alt = "Finish Line";
                    illustrationImage.loading = "lazy";
                    document.getElementById('finalDetailsText').style.display = '';
                    document.getElementById('finalDetails').style.display = '';
                    updateSubProgress(5);

                    illustrationImage.classList.remove('clickable');
                    nextButton.innerHTML = 'Next&nbsp;<i class="fas fa-arrow-right"></i>';
                    nextButton.setAttribute('type', 'button');

                    // Add event listener for validation
                    const mediaContactInput = document.getElementById('mediaContact');
                    const personalLinkInput = document.getElementById('personalLink');

                    mediaContactInput.addEventListener('input', checkFormValidityStage6);
                    personalLinkInput.addEventListener('input', checkFormValidityStage6);

                    // Run checkFormValidityStage6 initially
                    checkFormValidityStage6();

                    break;
                case 7:
                    // Stage 7: Application
                    document.querySelector('h2').textContent = "Application";
                    updateIllustration("account-creation", "jpg", webpSource, jpegSource, illustrationImage);
                    illustrationImage.alt = "Application";
                    illustrationImage.loading = "lazy";
                    document.getElementById('congratsText').style.display = '';
                    document.getElementById('applyDetails').style.display = '';

                    illustrationImage.classList.remove('clickable');
                    nextButton.textContent = 'Apply';
                    nextButton.setAttribute('type', 'submit');
                    updateSubProgress(99);

                    const accountEmailInput = document.getElementById('accountEmail');
                    accountEmailInput.addEventListener('input', checkFormValidityStage7);

                    // Run checkFormValidityStage7 initially
                    checkFormValidityStage7();
                    break;
                default:
                    console.error('Unknown stage:', stage);
            }

            updateUploadButtons();
        }

        let existingAthleteNames;
        // Flag Autocomplete Implementation
        document.addEventListener('DOMContentLoaded', function () {
            // Initialize the first stage
            goToStage(currentStage);

            fetch('/api/data/athletes')
                .then(response => response.json())
                .then(athletes => {
                    // Extract athlete names into a list
                    existingAthleteNames = athletes.map(athlete => athlete.Name);
                })
                .catch(error => {
                    console.error('Error fetching athlete names:', error);
                });

            fetch('/api/data/flags')
                .then(response => response.json())
                .then(flags => {
                    const flagInput = document.getElementById('flag');
                    let currentFocus;
                    flagInput.addEventListener('input', function () {
                        const inputVal = this.value.toLowerCase();
                        currentFocus = -1;
                        closeAllLists();
                        if (!inputVal) return false;

                        const listContainer = document.createElement('div');
                        listContainer.setAttribute('id', this.id + '-autocomplete-list');
                        listContainer.setAttribute('class', 'autocomplete-items');
                        const container = this.closest('.autocomplete-container');
                        container.appendChild(listContainer);

                        for (let i = 0; i < flags.length; i++) {
                            const lowerCaseFlag = flags[i].toLowerCase();

                            const regex = new RegExp(`\\b${inputVal}`);
                            if (regex.test(lowerCaseFlag)) {
                                const matchIndex = lowerCaseFlag.search(regex);
                                const listItem = document.createElement('div');

                                listItem.innerHTML =
                                    flags[i].substr(0, matchIndex) +
                                    "<strong>" + flags[i].substr(matchIndex, inputVal.length) + "</strong>" +
                                    flags[i].substr(matchIndex + inputVal.length);

                                // Set the flag name in a data attribute
                                listItem.setAttribute('data-value', flags[i]);

                                listItem.addEventListener('mousedown', function (e) {
                                    e.preventDefault(); // Prevent focus loss
                                    flagInput.value = this.getAttribute('data-value');
                                    flagInput.dispatchEvent(new Event('input'));

                                    closeAllLists();
                                });

                                listContainer.appendChild(listItem);
                                listItem.classList.add('autocomplete-item');
                            }
                        }
                    });

                    // Ensure the keydown event listener is added only once
                    if (!flagInput.hasAttribute('data-keydown-listener')) {
                        flagInput.addEventListener('keydown', function (e) {
                            let list = document.getElementById(this.id + '-autocomplete-list');
                            let items;
                            if (list) {
                                items = list.getElementsByClassName('autocomplete-item');
                            }
                            if (e.keyCode == 40) {
                                // Down key
                                currentFocus++;
                                addActive(items);
                                e.preventDefault();
                            } else if (e.keyCode == 38) {
                                // Up key
                                currentFocus--;
                                addActive(items);
                                e.preventDefault();
                            } else if (e.keyCode == 13) {
                                // Enter key
                                e.preventDefault();
                                if (currentFocus > -1) {
                                    if (items) {
                                        // Dispatch a mousedown event on the current item
                                        const mousedownEvent = new MouseEvent('mousedown', {
                                            bubbles: true,
                                            cancelable: true,
                                            view: window,
                                        });
                                        items[currentFocus].dispatchEvent(mousedownEvent);
                                    }
                                }
                            } else if (e.keyCode == 27) {
                                // Escape key
                                closeAllLists();
                            }
                        });
                        flagInput.setAttribute('data-keydown-listener', 'true');
                    }

                    function closeAllLists(elmnt) {
                        const items = document.getElementsByClassName('autocomplete-items');
                        for (let i = items.length - 1; i >= 0; i--) {
                            if (elmnt != items[i] && !items[i].contains(elmnt) && elmnt != flagInput) {
                                items[i].parentNode.removeChild(items[i]);
                            }
                        }
                        currentFocus = -1;
                    }

                    function addActive(items) {
                        if (!items) return false;
                        removeActive(items); // Clear previous active item
                        if (currentFocus >= items.length) currentFocus = 0;
                        if (currentFocus < 0) currentFocus = items.length - 1;
                        items[currentFocus].classList.add('autocomplete-active');
                    }

                    function removeActive(items) {
                        for (let i = 0; i < items.length; i++) {
                            items[i].classList.remove('autocomplete-active');
                        }
                    }

                    // Add a hover event to clear keyboard focus
                    document.addEventListener('mouseover', function (e) {
                        const hoveredItem = e.target.closest('.autocomplete-item');
                        if (hoveredItem) {
                            const list = document.getElementsByClassName('autocomplete-item');
                            removeActive(list); // Clear all active classes
                        }
                    });

                    document.addEventListener('click', function (e) {
                        closeAllLists(e.target);
                    });
                })
                .catch(error => {
                    console.error('Error fetching flags:', error);
                });

            // Fetch divisions and populate the division select element
            fetch('/api/data/divisions')
                .then(response => response.json())
                .then(divisions => {
                    const divisionSelect = document.getElementById('division');

                    // Clear existing options (if any)
                    divisionSelect.innerHTML = '';

                    // Populate divisions into the select element
                    divisions.forEach(function (division) {
                        const option = document.createElement('option');
                        option.value = division; // Use lowercase or any appropriate value
                        option.textContent = `${window.GetDivisionIcon(division)} ${division}`;
                        divisionSelect.appendChild(option);
                    });

                    // Optionally, set a default value or prompt
                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = '-- Select Division --';
                    defaultOption.disabled = true;
                    defaultOption.selected = true;
                    divisionSelect.insertBefore(defaultOption, divisionSelect.firstChild);

                    if (currentStage === 1) {
                        divisionSelect.addEventListener('change', checkFormValidityStage1);
                        checkFormValidityStage1(); // Check validity in case other fields are already filled
                    }

                    document.getElementById('division').addEventListener('change', function () {
                        document.getElementById('flag').focus();
                    });

                })
                .catch(error => {
                    console.error('Error fetching divisions:', error);
                });
        });

        // "Next" Button Click Event Handler
        document.getElementById('nextButton').addEventListener('click', function (event) {
            event.preventDefault(); // Prevent default button action

            // Scroll the heading into view
            document.querySelector('h2').scrollIntoView({ behavior: 'smooth' });

            // Remove the 'clickable' class from the illustrationImage
            document.getElementById('illustrationImage').classList.remove('clickable');

            if (currentStage < 7) {
                currentStage++;
                goToStage(currentStage);
            } else {
                // Final stage requires accountEmail
                let isValid = true;
                const accountEmail = document.getElementById('accountEmail').value.trim();
                const personalLink = document.getElementById('personalLink').value.trim();

                if (!accountEmail) {
                    isValid = false;
                    alert('Please enter your email.');
                } else if (!validator.isEmail(accountEmail)) {
                    isValid = false;
                    alert('Please enter a valid email address.');
                }

                if (personalLink && !validator.isURL(personalLink)) {
                    isValid = false;
                    alert('Please enter a valid URL for your personal link.');
                }

                if (isValid) {
                    // Collect all the data and send it to the backend via an API call
                    const applicantData = collectApplicantData();

                    // Disable the Apply button and change its text
                    const applyButton = document.getElementById('nextButton');
                    applyButton.disabled = true;
                    applyButton.textContent = 'Submitting...';

                    // Send the data via fetch POST request
                    fetch('/api/application/apply', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(applicantData)
                    })
                        .then(response => {
                            // Rest of your existing code...

                            if (response.ok) {
                                // Handle success, perhaps redirect or show a success message
                                alert('Application submitted successfully!');
                                localStorage.setItem('contactEmail', applicantData.accountEmail);
                                // Clear the image variables
                                profilePic = null;
                                proofPics = [];
                                // Redirect or reset the form
                                window.location.href = '/onboarding/application-review.html#appReviewTitle';
                            } else {
                                // Handle error
                                alert('Failed to submit application. Please try again later.');
                                applyButton.disabled = false;
                                applyButton.textContent = 'Apply';
                            }

                        })
                        .catch(error => {
                            console.error('Error submitting application:', error);
                            alert('An error occurred while submitting your application.');
                            applyButton.disabled = false;
                            applyButton.textContent = 'Apply';
                        });
                }
            }
        });

        // "Back" Button Click Event Handler
        document.getElementById('backButton').addEventListener('click', function () {
            if (currentStage > 1) {
                currentStage--;
                goToStage(currentStage);
            } else {
                // If on the first stage, go back to the previous page
                window.history.back();
            }
        });

        function attachUploadEventListeners() {
            // Set up event listener for the upload button
            const uploadButton = document.getElementById('uploadButton');
            if (uploadButton && !uploadButton.hasAttribute('data-listener')) {
                uploadButton.addEventListener('click', function () {
                    document.getElementById('profilePicInput').click();
                });
                uploadButton.setAttribute('data-listener', 'true');
            }

            // Add click event to the image to trigger file selection
            const illustrationImage = document.getElementById('illustrationImage');
            if (illustrationImage && !illustrationImage.hasAttribute('data-listener')) {
                illustrationImage.addEventListener('click', function () {
                    document.getElementById('profilePicInput').click();
                });
                illustrationImage.setAttribute('data-listener', 'true');
            }

            // Handle the image upload and initialize Cropper.js
            const profilePicInput = document.getElementById('profilePicInput');
            let cropper; // Declare Cropper instance at a higher scope

            if (profilePicInput && !profilePicInput.hasAttribute('data-listener')) {
                profilePicInput.addEventListener('change', function (event) {
                    if (!event.target.files.length) return; // Reset if no file selected
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            // Disable "Next" button while cropping
                            const nextButton = document.getElementById('nextButton');
                            nextButton.disabled = true;
                            nextButton.classList.add('disabled-button');
                            updateUploadButtons();

                            document.getElementById('cropperImage').src = e.target.result;

                            document.getElementById('uploadPart').style.display = 'none';
                            document.getElementById('croppingPart').style.display = 'block';

                            // Initialize Cropper only once
                            if (!cropper) {
                                cropper = new Cropper(document.getElementById('cropperImage'), {
                                    aspectRatio: 1,
                                    viewMode: 1,
                                    autoCropArea: 1,
                                    movable: true,
                                    zoomable: true,
                                    rotatable: false,
                                    scalable: false,
                                    cropBoxResizable: true,
                                    minCropBoxWidth: 200,
                                    minCropBoxHeight: 150,
                                });
                            }
                        };
                        reader.readAsDataURL(file);
                    }
                });

                // Add the crop button event listener once
                document.getElementById('cropButton').addEventListener('click', function () {
                    if (cropper) {
                        const croppedCanvas = cropper.getCroppedCanvas({
                            width: 1024,
                            height: 768,
                        });
                        const croppedImageDataURL = croppedCanvas.toDataURL('image/png');
                        document.getElementById('illustrationPicture').style.display = 'none';
                        document.getElementById('profileImage').style.display = '';
                        document.getElementById('profileImage').src = croppedImageDataURL;

                        profilePic = croppedImageDataURL;

                        cropper.destroy(); // Clean up the Cropper instance
                        cropper = null; // Reset the Cropper instance

                        document.getElementById('uploadPart').style.display = '';
                        document.getElementById('croppingPart').style.display = 'none';

                        const nextButton = document.getElementById('nextButton');
                        nextButton.disabled = false;
                        nextButton.classList.remove('disabled-button');
                        updateUploadButtons();

                        attachUploadEventListeners();
                    }
                });

                profilePicInput.setAttribute('data-listener', 'true');
            }
        }

        function updateProofImageContainer() {
            let container = document.getElementById('proofImageContainer');
            container.innerHTML = '';
            // Use the global `proofPics` variable directly
            if (proofPics.length > 0) {
                container.innerHTML = '<p><strong>Proof uploaded successfully.</strong></p>';
                for (let i = 0; i < proofPics.length; i++) {
                    let imgContainer = document.createElement('div');
                    imgContainer.style = 'position: relative; display: inline-block; margin: 0.5rem;';

                    let img = document.createElement('img');
                    img.src = proofPics[i];
                    img.alt = 'Proof Image ' + (i + 1);
                    img.style = 'max-width: 100%; border: 2px solid var(--dark-text-color); border-radius: 8px;';

                    let removeButton = document.createElement('button');
                    removeButton.textContent = 'Remove';
                    removeButton.style = 'position: absolute; top: 5px; right: 5px; background-color: rgba(255, 0, 0, 0.7); color: var(--light-text-color); border: none; border-radius: 3px; cursor: pointer;';
                    removeButton.addEventListener('click', function () {
                        proofPics.splice(i, 1);
                        updateProofImageContainer();
                        // Check proof images
                        checkProofImages();
                    });

                    imgContainer.appendChild(img);
                    imgContainer.appendChild(removeButton);
                    container.appendChild(imgContainer);
                }
            }
        }

        function checkProofImages() {
            if (currentStage !== 5) return;

            const nextButton = document.getElementById('nextButton');
            if (proofPics.length > 0) {
                nextButton.disabled = false;
                nextButton.classList.remove('disabled-button');
                updateUploadButtons();
            } else {
                nextButton.disabled = true;
                nextButton.classList.add('disabled-button');
                updateUploadButtons();
            }
        }

        function checkFormValidityStage1() {
            if (currentStage !== 1) return;

            const nameInput = document.getElementById('name');
            const flagInput = document.getElementById('flag');
            const divisionSelect = document.getElementById('division');
            const nextButton = document.getElementById('nextButton');

            const nameValue = nameInput.value.trim();
            const flagValue = flagInput.value.trim();
            const nameValidationResult = validateName(nameValue);
            const flagValidationResult = validateFlag(flagValue);
            const nameValid = nameValidationResult.valid;
            const flagValid = flagValidationResult.valid;
            const divisionSelected = divisionSelect && divisionSelect.value.trim() !== '';

            if (!nameValid && nameValue.length >= 3) {
                // Display error message immediately as the user types
                document.getElementById('nameError').textContent = nameValidationResult.error;
            } else {
                document.getElementById('nameError').textContent = '';
            }

            if (!flagValid && flagValue.length >= 3) {
                // Display error message immediately as the user types
                document.getElementById('flagError').textContent = flagValidationResult.error;
            } else {
                document.getElementById('flagError').textContent = '';
            }

            if (nameValid && flagValid && divisionSelected) {
                nextButton.disabled = false;
                nextButton.classList.remove('disabled-button');
            } else {
                nextButton.disabled = true;
                nextButton.classList.add('disabled-button');
            }
        }

        function checkFormValidityStage2() {
            if (currentStage !== 2) return;

            const whyInput = document.getElementById('why');
            const nextButton = document.getElementById('nextButton');

            const charCounter = document.getElementById('whyCharCounter');
            const whyValue = whyInput.value;
            const charCount = whyValue.length;

            if (charCount == 0) {
                charCounter.classList.add('hidden');
            } else {
                charCounter.classList.remove('hidden');
            }

            // Update character counter
            charCounter.textContent = charCount + '/250';

            // Color the counter based on character count
            if (charCount < 30) {
                charCounter.textContent = charCount + '/30';
                charCounter.style.color = 'red';
            } else if (charCount <= 250) {
                charCounter.textContent = charCount + '/250';
                charCounter.style.color = 'green';
            } else {
                charCounter.textContent = charCount + '/250';
                charCounter.style.color = 'red';
            }

            // Enable or disable the Next button based on validity
            if (charCount >= 30 && charCount <= 250) {
                nextButton.disabled = false;
                nextButton.classList.remove('disabled-button');
            } else {
                nextButton.disabled = true;
                nextButton.classList.add('disabled-button');
            }
        }

        function checkFormValidityStage6() {
            if (currentStage !== 6) return;

            const mediaContactInput = document.getElementById('mediaContact');
            const personalLinkInput = document.getElementById('personalLink');
            const nextButton = document.getElementById('nextButton');

            const mediaContactFilled = mediaContactInput.value.trim() !== '';
            const personalLinkValue = personalLinkInput.value.trim();

            let isValid = true;

            if (!mediaContactFilled) {
                isValid = false;
            }

            if (personalLinkValue && !validator.isURL(personalLinkValue)) {
                isValid = false;
                personalLinkInput.setCustomValidity('Please enter a valid URL.');
            } else {
                personalLinkInput.setCustomValidity('');
            }

            if (isValid) {
                nextButton.disabled = false;
                nextButton.classList.remove('disabled-button');
            } else {
                nextButton.disabled = true;
                nextButton.classList.add('disabled-button');
            }
        }

        function checkFormValidityStage7() {
            if (currentStage !== 7) return;

            const accountEmailInput = document.getElementById('accountEmail');
            const nextButton = document.getElementById('nextButton');

            const emailFilled = accountEmailInput.value.trim() !== '';

            if (emailFilled) {
                nextButton.disabled = false;
                nextButton.classList.remove('disabled-button');
            } else {
                nextButton.disabled = true;
                nextButton.classList.add('disabled-button');
            }
        }

        function validateName(name) {
            // Trim leading and trailing whitespace
            name = name.trim();

            // Ensure the name is at least 3 characters long
            if (name.length < 3) {
                return { valid: false, error: 'Name must be at least 3 characters long.' };
            }

            // Check if name already exists (case insensitive)
            if (existingAthleteNames.some(existingName => existingName.toLowerCase() === name.toLowerCase())) {
                return { valid: false, error: 'An athlete with that name is already registered.' };
            }

            // Regular expression to validate the name
            const nameRegex = /^[A-Za-zÀ-ÖØ-öø-ÿ][A-Za-zÀ-ÖØ-öø-ÿ0-9\s'-]{2,99}$/;

            if (!nameRegex.test(name)) {
                return { valid: false, error: 'Name contains invalid characters.' };
            }

            return { valid: true };
        }

        function validateFlag(flag) {
            // Trim leading and trailing whitespace
            flag = flag.trim();

            // Ensure the flag is at least 3 characters long
            if (flag.length < 3) {
                return { valid: false, error: 'Flag must be at least 3 characters long.' };
            }

            // Regular expression to validate the flag
            const flagRegex = /^[A-Za-zÀ-ÖØ-öø-ÿ][A-Za-zÀ-ÖØ-öø-ÿ0-9\s'(),.\-]{2,99}$/;

            if (!flagRegex.test(flag)) {
                return { valid: false, error: 'Flag contains invalid characters.' };
            }

            return { valid: true };
        }
    </script>
    <script src="https://unpkg.com/cropperjs@1.5.13/dist/cropper.min.js"></script>
</body>
</html>