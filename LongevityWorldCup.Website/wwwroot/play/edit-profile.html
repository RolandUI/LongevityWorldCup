<!DOCTYPE html>
<html lang="en">
<head>
    <!--HEAD-->
    <link rel="stylesheet" href="https://unpkg.com/cropperjs@1.5.13/dist/cropper.min.css">
    <style>
        /* Hide the join-game button in the header */
        .join-game {
            display: none;
        }

        #divisionDisplayWrapper {
            position: relative;
            width: 80%;
            max-width: 400px;
            margin: 1rem auto;
        }

        #divisionDisplayInput {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #ccc;
            border-radius: 30px;
            font-size: 1rem;
            transition: border-color 0.2s;
            background-color: #f9f9f9;
        }

            #divisionDisplayInput:focus {
                outline: none;
                border-color: #4CAF50;
                box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.3);
            }

        #divisionDisplaySelect {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #ccc;
            border-radius: 30px;
            font-size: 1rem;
            transition: border-color 0.2s;
            background-color: #f9f9f9;
            appearance: none;
        }

            #divisionDisplaySelect:focus {
                outline: none;
                border-color: #4CAF50;
                box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.3);
            }

        .error-message {
            display: block;
            color: red;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        /* center the cropper modal and its buttons */
        #changeProfileCropperModal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            z-index: 10000;
            padding: 1.5rem;
            width: 80vw;
            max-width: 360px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 1rem;
        }

            #changeProfileCropperModal button {
                margin-top: 0.5rem;
                width: auto;
            }

            /* make the modal’s inner options fill its container */
            #changeProfileCropperModal .options-container {
                width: 100%;
                max-width: none; /* override any global cap */
                display: flex;
                flex-direction: column;
                gap: 0.75rem; /* adjust spacing between buttons if you like */
            }

            #changeProfileCropperModal .option-button {
                width: 100%;
                max-width: none; /* ensure they stretch edge-to-edge */
            }

        #changeProfileCropperImage {
            max-width: 100%;
            max-height: 300px;
            object-fit: contain;
        }

        /* dark backdrop & lock scroll when modal is open */
        #modalOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            z-index: 9998; /* sits just under the modal’s 10000 */
        }

        .no-scroll {
            overflow: hidden;
        }

        .options-container.inline-option-group {
            flex-direction: row;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            width: 80%;
            max-width: 400px;
            margin: 0 auto;
        }

        /* shrink any icon-only button down to its icon */
        .option-button.icon-only {
            width: 60px;
            height: 60px;
            max-width: none;
            padding: 0;
            margin: 0;
        }

        #editOptionsGroup {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            gap: 0.5rem;
            margin: 0 auto;
        }

        #changeProfilePicButton {
            width: 100%;
            flex: 1 1 0;
        }

        .icon-only {
            flex: 0 0 60px;
            width: 60px;
            height: 60px;
        }
    </style>
</head>
<body>
    <!--HEADER-->
    <main>
        <h2 id="character-title" data-aos="fade" data-aos-duration="700" data-aos-delay="250">Character Selection</h2>
        <div style="text-align: center;" data-aos="fade" data-aos-duration="700" data-aos-delay="300">
            <picture>
                <source srcset="../assets/content-images/headshot.webp" type="image/webp">
                <source srcset="../assets/content-images/headshot.jpg" type="image/jpeg">
                <img src="../assets/content-images/headshot.jpg" alt="Headshot" class="illustration" loading="lazy">
            </picture>
        </div>
        <div id="editOptionsGroup" cdata-aos="fade" data-aos-duration="700" data-aos-delay="350">
            <div id="changeProfilePicWrapper" class="options-container inline-option-group">
                <button id="changeProfilePicButton" class="option-button grey">
                    Change Profile Picture
                </button>
                <input type="file" id="profilePicInputModal" accept="image/*" style="display: none;">
                <button id="restoreProfilePicButton" class="option-button icon-only" style="display:none" title="Restore">
                    <i class="fa fa-undo"></i>
                </button>
            </div>
            <div id="divisionDisplayWrapper" class="options-container inline-option-group">
                <select id="divisionDisplaySelect"></select>
                <button id="restoreDivisionBtn" class="option-button icon-only" style="display:none" title="Restore Division">
                    <i class="fa fa-undo"></i>
                </button>
            </div>
        </div>
        <div class="options-container" data-aos="fade" data-aos-duration="700" data-aos-delay="400">
            <button id="submitButton" type="submit" disabled class="option-button green"></button>
            <button class="option-button back-button" onclick="window.goBackOrHome()">
                <i class="fas fa-arrow-left"></i>&nbsp;Back
            </button>
        </div>

        <div id="changeProfileCropperModal" style="display:none">
            <img id="changeProfileCropperImage" src="" alt="Cropper Preview">
            <div class="options-container">
                <button id="changeProfileCropButton" class="option-button green">Crop & Save</button>
                <button id="changeProfileCancelButton" class="option-button grey">Cancel</button>
            </div>
        </div>
        <div id="modalOverlay"></div>
    </main>
    <!--FOOTER-->
    <script>
        const athlete = JSON.parse(sessionStorage.getItem('selectedAthlete'));

        if (!sessionStorage.getItem('initialProfilePicSrc')) sessionStorage.setItem('initialProfilePicSrc', athlete.ProfilePic);
        const originalProfilePicSrc = sessionStorage.getItem('initialProfilePicSrc');

        if (!sessionStorage.getItem('initialDivision')) sessionStorage.setItem('initialDivision', athlete.Division);
        const originalDivision = sessionStorage.getItem('initialDivision');

        setSubmitChangeRequestButton();

        document.addEventListener('DOMContentLoaded', function () {
            setTimeout(() => {
                const viewTarget = document.querySelector('h2');
                viewTarget.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 500);

            document.getElementById('character-title').textContent = athlete.Name;
            document.querySelector('picture').innerHTML = `
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <img src="${athlete.ProfilePic}"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                alt="${athlete.Name} headshot"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                class="illustration"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                loading="lazy">`;
            if (athlete.ProfilePic !== originalProfilePicSrc) {
                document.getElementById('restoreProfilePicButton').style.display = 'inline-flex';
                document.getElementById('submitButton').disabled = false;
            }

            // — DIVISION PREFILL & CHANGE/RESTORE LOGIC —
            const divisionSelect = document.getElementById('divisionDisplaySelect');
            const restoreDivisionBtn = document.getElementById('restoreDivisionBtn');

            // Populate the dropdown
            fetch('/api/data/divisions')
                .then(r => r.json())
                .then(divs => {
                    divisionSelect.innerHTML = '';
                    divs.forEach(d => {
                        const opt = document.createElement('option');
                        opt.value = d;
                        opt.textContent = `${window.TryGetDivisionIcon(d)} ${d}`;
                        divisionSelect.appendChild(opt);
                    });
                    divisionSelect.value = athlete.Division;

                    if (athlete.Division !== originalDivision) {
                        restoreDivisionBtn.style.display = 'inline-flex';
                        document.getElementById('submitButton').disabled = false;
                    }
                });

            // When the user picks a different division…
            divisionSelect.addEventListener('change', () => {
                athlete.Division = divisionSelect.value;
                sessionStorage.setItem('selectedAthlete', JSON.stringify(athlete));
                restoreDivisionBtn.style.display = 'inline-flex';
                document.getElementById('submitButton').disabled = false;
            });

            // Restore original division
            restoreDivisionBtn.addEventListener('click', () => {
                divisionSelect.value = originalDivision;
                athlete.Division = originalDivision;
                sessionStorage.setItem('selectedAthlete', JSON.stringify(athlete));
                restoreDivisionBtn.style.display = 'none';
                document.getElementById('submitButton').disabled = true;
            });

        });

        function setSubmitChangeRequestButton() {
            const submitButton = document.getElementById('submitButton');
            submitButton.innerHTML = 'Submit Change Request&nbsp;<i class="fa fa-rocket"></i>';
            submitButton.setAttribute('type', 'submit');
        }

        const changeProfileBtn = document.getElementById('changeProfilePicButton');
        const changeProfileInput = document.getElementById('profilePicInputModal');
        changeProfileBtn.addEventListener('click', () => {
            changeProfileInput.click();
        });
        changeProfileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (evt) => {
                const cropperModal = document.getElementById('changeProfileCropperModal');
                const cropperImage = document.getElementById('changeProfileCropperImage');
                cropperImage.src = evt.target.result;
                cropperModal.style.display = 'flex';
                document.getElementById('modalOverlay').style.display = 'block';
                document.body.classList.add('no-scroll');

                // expose globally so crop/cancel buttons can access it
                window.changeProfileCropper = new Cropper(cropperImage, {
                    aspectRatio: 1,
                    viewMode: 1,
                    autoCropArea: 1,
                });
            };
            reader.readAsDataURL(file);
        });

        // Crop & Cancel handlers for change-profile
        const cropBtn = document.getElementById('changeProfileCropButton');
        const cancelBtn = document.getElementById('changeProfileCancelButton');
        cropBtn.addEventListener('click', () => {
            const canvas = window.changeProfileCropper.getCroppedCanvas({
                width: 1024,
                height: 1024,
            });
            const newSrc = canvas.toDataURL('image/png');
            const imgEl = document.querySelector('.illustration');
            imgEl.src = newSrc;
            imgEl.alt = athlete.Name + ' headshot';
            athlete.ProfilePic = newSrc;
            sessionStorage.setItem('selectedAthlete', JSON.stringify(athlete));
            document.getElementById('restoreProfilePicButton').style.display = 'inline-flex';

            // enable the “Submit Change Request” button now that there’s a new image
            document.getElementById('submitButton').disabled = false;
            window.changeProfileCropper.destroy();
            document.getElementById('modalOverlay').style.display = 'none';
            document.body.classList.remove('no-scroll');
            document.getElementById('changeProfileCropperModal').style.display = 'none';
            changeProfileInput.value = '';
        });
        cancelBtn.addEventListener('click', () => {
            window.changeProfileCropper.destroy();
            document.getElementById('modalOverlay').style.display = 'none';
            document.body.classList.remove('no-scroll');
            document.getElementById('changeProfileCropperModal').style.display = 'none';
            changeProfileInput.value = '';
        });
        const restoreBtn = document.getElementById('restoreProfilePicButton');
        restoreBtn.addEventListener('click', () => {
            const imgEl = document.querySelector('.illustration');
            imgEl.src = originalProfilePicSrc;
            athlete.ProfilePic = originalProfilePicSrc;
            sessionStorage.setItem('selectedAthlete', JSON.stringify(athlete));
            restoreBtn.style.display = 'none';
            // go back to “nothing changed,” so disable submit again
            document.getElementById('submitButton').disabled = true;
        });
    </script>
    <script src="https://unpkg.com/cropperjs@1.5.13/dist/cropper.min.js" defer></script>
</body>
</html>