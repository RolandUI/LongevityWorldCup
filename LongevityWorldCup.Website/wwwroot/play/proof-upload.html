<!DOCTYPE html>
<html lang="en">
<head>
    <!--HEAD-->
    <style>
        /* Hide the join-game button in the header */
        .join-game {
            display: none;
        }

        .option-button.already-have {
            background: var(--main-action-color);
            transition: background 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
        }

            .option-button.already-have:hover {
                background: var(--main-action-selected-color);
                transform: scale(1.03);
                box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2); /* Enhanced hover shadow */
            }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: linear-gradient(135deg, #cccccc, #e0e0e0); /* Subtle disabled gradient */
            box-shadow: none; /* Remove shadows for disabled buttons */
        }

        #proofImageContainer {
            width: 90%;
            max-width: 600px;
            margin: 1rem auto 0;
            text-align: center;
        }

            #proofImageContainer div {
                position: relative;
                display: inline-block;
                margin: 0.5rem;
            }

            #proofImageContainer img {
                max-width: 200px;
                border: 2px solid var(--dark-text-color);
                border-radius: 8px;
            }

            #proofImageContainer button {
                position: absolute;
                top: 5px;
                right: 5px;
                background-color: rgba(255, 0, 0, 0.7);
                color: var(--light-text-color);
                border: none;
                border-radius: 3px;
                cursor: pointer;
            }
    </style>
</head>
<body>
    <!--HEADER-->
    <main>
        <h2 id="character-title" data-aos="fade" data-aos-duration="700" data-aos-delay="250">Character Selection</h2>
        <div style="text-align: center;" data-aos="fade" data-aos-duration="700" data-aos-delay="300">
            <picture>
                <source srcset="../assets/content-images/proof.webp" type="image/webp">
                <source srcset="../assets/content-images/proof.jpg" type="image/jpeg">
                <img src="../assets/content-images/proof.jpg" alt="Proof" class="illustration" loading="lazy">
            </picture>
        </div>
        <p id="mainProofInstructions" data-aos="fade" data-aos-duration="700" data-aos-delay="350" style="text-align:center"></p>
        <p id="subProofInstructions" class="smaller-text" data-aos="fade" data-aos-duration="700" data-aos-delay="400" style="text-align:center"></p>

        <div class="options-container" data-aos="fade" data-aos-duration="700" data-aos-delay="450">
            <input type="file" id="proofPicInput" accept="image/*" style="display: none;" multiple>
            <button type="button" id="uploadProofButton" class="option-button already-have">
                Upload Proof Images
            </button>
        </div>

        <fieldset id="proofImageContainer" style="text-align: center; margin-top: 1rem;"></fieldset>

        <div class="options-container" data-aos="fade" data-aos-duration="700" data-aos-delay="450">
            <button id="submitButton" type="submit" class="option-button already-have">
                Submit New Results
            </button>
            <button class="option-button back-button" onclick="window.goBackOrHome()">
                <i class="fas fa-arrow-left"></i>&nbsp;Back
            </button>
        </div>
    </main>
    <!--FOOTER-->
    <script>
        const athlete = JSON.parse(sessionStorage.getItem('selectedAthlete'));
        let proofPics = [];

        document.addEventListener('DOMContentLoaded', function () {
            setTimeout(() => {
                const viewTarget = document.querySelector('h2');
                viewTarget.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 500);

            document.getElementById('character-title').textContent = athlete.Name;

            const mainProofInstructions = document.getElementById('mainProofInstructions');
            if (mainProofInstructions) {
                mainProofInstructions.innerHTML = window.getMainProofInstructionsInnerHTML();
            }

            const subProofInstructions = document.getElementById('subProofInstructions');
            if (subProofInstructions) {
                subProofInstructions.innerHTML = window.getSubProofInstructionsInnerHTML();
            }

            var submitButton = document.getElementById('submitButton');
            const uploadProofButton = document.getElementById('uploadProofButton');
            const proofPicInput = document.getElementById('proofPicInput');
            const proofImageContainer = document.getElementById('proofImageContainer');

            window.setupProofUploadHTML(submitButton, uploadProofButton, proofPicInput, proofImageContainer, proofPics);

            submitButton.addEventListener('click', function () {
                if (!athlete || !athlete.Name) {
                    customAlert('No athlete selected. Please return and choose your athlete.');
                    return;
                }

                const biomarkerData = JSON.parse(sessionStorage.getItem('biomarkerData'));
                if (!biomarkerData || !biomarkerData.Biomarkers || !biomarkerData.Biomarkers.length) {
                    customAlert('Biomarker data is missing. Please fill out the biomarker form first.');
                    return;
                }

                const applicantData = {
                    name: athlete.Name,
                    accountEmail: sessionStorage.getItem('contactEmail') || null,
                    chronoBioDifference: sessionStorage.getItem('chronoBioDifference') || null,
                    biomarkers: biomarkerData.Biomarkers,
                    proofPics: proofPics
                };

                const submitButton = document.getElementById('submitButton');
                const uploadProofButton = document.getElementById('uploadProofButton');
                submitButton.disabled = true;
                uploadProofButton.disabled = true;
                submitButton.textContent = 'Submitting...';

                fetchWithTimeout('/api/application/application', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(applicantData)
                }, 21000)
                    .then(response => {
                        if (response.ok) {
                            customAlert('Results submitted successfully!').then(() => {
                                proofPics = [];

                                sessionStorage.setItem("came-from", "proof-upload");
                                window.location.href = '/onboarding/application-review.html';
                            });
                        } else {
                            response.text().then(badResponse => {
                                customAlert(`Failed to submit results. Please try again later.\n\n${badResponse}`).then(() => {
                                    submitButton.disabled = false;
                                    uploadProofButton.disabled = false;
                                    submitButton.textContent = 'Submit New Results';
                                });
                            });
                        }
                    })
                    .catch(error => {
                        customAlert(`An error occurred:\n\n${error}`).then(() => {
                            submitButton.disabled = false;
                            uploadProofButton.disabled = false;
                            submitButton.textContent = 'Submit New Results';
                        });
                    });
            });
        });
    </script>
</body>
</html>